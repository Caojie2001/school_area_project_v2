<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºç­‘é¢ç§¯ç®¡ç† - é«˜æ ¡å»ºç­‘é¢ç§¯ç¼ºå£è®¡ç®—å™¨</title>
    <!-- å¼•å…¥æ¨¡å—åŒ–CSSæ ·å¼ -->
    <link rel="stylesheet" href="../css/main.css">
</head>
<body>
    <div class="app-container">
        <!-- ä¾§è¾¹æ å®¹å™¨ -->
        <div id="sidebarContainer"></div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="page-content active">
                <!-- é¡µé¢å¤´éƒ¨å®¹å™¨ -->
                <div id="pageHeaderContainer"></div>
                
                <!-- é¡µé¢å†…å®¹å®¹å™¨ -->
                <div class="content-body" id="pageContentContainer">
                    <!-- å»ºç­‘é¢ç§¯ç®¡ç†è¡¨å• -->
                    <div class="online-form-section" id="areaManagementSection">
                        <div class="form-container">
                            <!-- å­¦æ ¡é€‰æ‹©è¡Œ -->
                            <div class="form-row" style="margin-bottom: 0;">
                                <div class="form-group form-group-school-name">
                                    <label for="schoolName">å­¦æ ¡åç§° *</label>
                                    <select id="schoolName" name="schoolName" required class="form-control" onchange="handleSchoolChange()">
                                        <option value="">è¯·é€‰æ‹©å­¦æ ¡</option>
                                    </select>
                                    <small class="school-type-display" id="schoolTypeDisplay"></small>
                                </div>
                            </div>
                            
                            <!-- 1. ç°çŠ¶é¢ç§¯æ¨¡å— -->
                            <div class="card" id="currentAreaSection">
                                <h3>1. ç°çŠ¶é¢ç§¯</h3>
                                <div class="form-row" style="margin-bottom: 0;">
                                    <div class="form-group">
                                        <label for="dataSource">æ•°æ®æ¥æº_å»ºç­‘é¢ç§¯(ã¡)_ç°çŠ¶ *</label>
                                        <select id="dataSource" name="dataSource" required class="form-control" onchange="handleDataSourceChange()" disabled>
                                            <option value="">è¯·å…ˆé€‰æ‹©å­¦æ ¡</option>
                                        </select>
                                        <small class="school-type-display" id="dataSourceHint" style="display: none;">é€‰æ‹©è¦æŸ¥çœ‹æˆ–ç¼–è¾‘çš„æ•°æ®æ¥æº</small>
                                    </div>
                                </div>
                                
                                <!-- æ•°æ®æ¥æºçš„æ•°æ®æ˜¾ç¤º -->
                                <div id="dataSourceDataSection" class="card" style="margin-top: 0px; padding: 15px; background-color: #f8f9fa;">
                                    <h4 style="margin-top: 0px; margin-bottom: 15px; color: #495057;">æ•°æ®æ¥æºçš„æ•°æ®ï¼š</h4>
                                    
                                    <!-- ç¬¬ä¸€è¡Œï¼šæ•™å­¦ã€åŠå…¬ã€åå‹¤ -->
                                    <div class="form-row" style="margin-bottom: 10px;">
                                        <div class="form-group">
                                            <label for="teachingAreaCurrent">æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶_æ•°æ®æ¥æº</label>
                                            <input type="number" id="teachingAreaCurrent" name="teachingAreaCurrent" 
                                                   class="form-control" value="0.00" step="0.01" readonly 
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                        </div>
                                        <div class="form-group">
                                            <label for="officeAreaCurrent">åŠå…¬ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶_æ•°æ®æ¥æº</label>
                                            <input type="number" id="officeAreaCurrent" name="officeAreaCurrent" 
                                                   class="form-control" value="0.00" step="0.01" readonly 
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                        </div>
                                        <div class="form-group">
                                            <label for="logisticsAreaCurrent">åå‹¤è¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶_æ•°æ®æ¥æº</label>
                                            <input type="number" id="logisticsAreaCurrent" name="logisticsAreaCurrent" 
                                                   class="form-control" value="0.00" step="0.01" readonly 
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                        </div>
                                    </div>
                                    
                                    <!-- ç¬¬äºŒè¡Œï¼šç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯ã€å­¦ç”Ÿå®¿èˆã€å…¶ä»–ç”Ÿæ´»ç”¨æˆ¿ -->
                                    <div class="form-row" style="margin-bottom: 10px;">
                                        <div class="form-group">
                                            <label for="totalLivingAreaCurrent">ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯(ã¡)_ç°çŠ¶_æ•°æ®æ¥æº</label>
                                            <input type="number" id="totalLivingAreaCurrent" name="totalLivingAreaCurrent" 
                                                   class="form-control" value="0.00" step="0.01" readonly 
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                        </div>
                                        <div class="form-group">
                                            <label for="dormitoryAreaCurrent">å…¶ä¸­ï¼šå­¦ç”Ÿå®¿èˆé¢ç§¯(ã¡)_ç°çŠ¶_æ•°æ®æ¥æº</label>
                                            <input type="number" id="dormitoryAreaCurrent" name="dormitoryAreaCurrent" 
                                                   class="form-control" value="0.00" step="0.01" readonly 
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                        </div>
                                        <div class="form-group">
                                            <label for="otherLivingAreaCurrent">å…¶ä¸­ï¼šå…¶ä»–ç”Ÿæ´»ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶_æ•°æ®æ¥æº</label>
                                            <input type="number" id="otherLivingAreaCurrent" name="otherLivingAreaCurrent" 
                                                   class="form-control" value="0.00" step="0.01" readonly 
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                            <small style="color: #6c757d; display: block; margin-top: 5px;">
                                                ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯-å­¦ç”Ÿå®¿èˆé¢ç§¯
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- ç¬¬ä¸‰è¡Œï¼šå»ºç­‘æ€»é¢ç§¯ -->
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="currentBuildingArea">å»ºç­‘æ€»é¢ç§¯(ã¡)_ç°çŠ¶_æ•°æ®æ¥æº</label>
                                            <input type="number" id="currentBuildingArea" name="currentBuildingArea" 
                                                   class="form-control" value="0.00" step="0.01" readonly 
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                            <small style="color: #6c757d; display: block; margin-top: 5px; margin-bottom: 0;">
                                                æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯+åŠå…¬ç”¨æˆ¿é¢ç§¯+ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯+åå‹¤è¾…åŠ©ç”¨æˆ¿é¢ç§¯
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- æ•°æ®æ¥æºçš„æ•°æ®æ˜¾ç¤ºï¼ˆå¯ç¼–è¾‘ï¼‰ -->
                                <div id="dataSourceDataSection2" class="card" style="margin-top: 15px; padding: 15px; background-color: #f8f9fa;">
                                    <h4 style="margin-top: 0px; margin-bottom: 15px; color: #495057;">ä¿®æ”¹åçš„æ•°æ®ï¼š</h4>
                                    
                                    <!-- ç¬¬ä¸€è¡Œï¼šæ•™å­¦ã€åŠå…¬ã€åå‹¤ -->
                                    <div class="form-row" style="margin-bottom: 10px;">
                                        <div class="form-group">
                                            <label for="teachingAreaCurrent2">æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶</label>
                                            <input type="text" id="teachingAreaCurrent2" name="teachingAreaCurrent2" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculateCurrentAreas2();">
                                        </div>
                                        <div class="form-group">
                                            <label for="officeAreaCurrent2">åŠå…¬ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶</label>
                                            <input type="text" id="officeAreaCurrent2" name="officeAreaCurrent2" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculateCurrentAreas2();">
                                        </div>
                                        <div class="form-group">
                                            <label for="logisticsAreaCurrent2">åå‹¤è¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶</label>
                                            <input type="text" id="logisticsAreaCurrent2" name="logisticsAreaCurrent2" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculateCurrentAreas2();">
                                        </div>
                                    </div>
                                    
                                    <!-- ç¬¬äºŒè¡Œï¼šç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯ã€å­¦ç”Ÿå®¿èˆã€å…¶ä»–ç”Ÿæ´»ç”¨æˆ¿ -->
                                    <div class="form-row" style="margin-bottom: 10px;">
                                        <div class="form-group">
                                            <label for="totalLivingAreaCurrent2">ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯(ã¡)_ç°çŠ¶</label>
                                            <input type="text" id="totalLivingAreaCurrent2" name="totalLivingAreaCurrent2" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculateCurrentAreas2();">
                                        </div>
                                        <div class="form-group">
                                            <label for="dormitoryAreaCurrent2">å…¶ä¸­ï¼šå­¦ç”Ÿå®¿èˆé¢ç§¯(ã¡)_ç°çŠ¶</label>
                                            <input type="text" id="dormitoryAreaCurrent2" name="dormitoryAreaCurrent2" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculateCurrentAreas2();">
                                        </div>
                                        <div class="form-group">
                                            <label for="otherLivingAreaCurrent2">å…¶ä¸­ï¼šå…¶ä»–ç”Ÿæ´»ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶</label>
                                            <input type="text" id="otherLivingAreaCurrent2" name="otherLivingAreaCurrent2" 
                                                   class="form-control" value="0.00" readonly
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                            <small style="color: #6c757d; display: block; margin-top: 5px;">
                                                ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯-å­¦ç”Ÿå®¿èˆé¢ç§¯
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- ç¬¬ä¸‰è¡Œï¼šå»ºç­‘æ€»é¢ç§¯ -->
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="currentBuildingArea2">å»ºç­‘æ€»é¢ç§¯(ã¡)_ç°çŠ¶</label>
                                            <input type="text" id="currentBuildingArea2" name="currentBuildingArea2" 
                                                   class="form-control" value="0.00" readonly
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                            <small style="color: #6c757d; display: block; margin-top: 5px; margin-bottom: 0;">
                                                æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯+åŠå…¬ç”¨æˆ¿é¢ç§¯+ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯+åå‹¤è¾…åŠ©ç”¨æˆ¿é¢ç§¯
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 2. æ‹Ÿå»ºæˆé¢ç§¯æ¨¡å— -->
                            <div class="card" id="baselineAreaSection">
                                <h3>2. æ‹Ÿå»ºæˆé¢ç§¯(æˆªæ­¢åˆ°æµ‹ç®—å¹´ä»½)</h3>
                                
                                <!-- æ‹Ÿå»ºæˆå‰æœŸé¢ç§¯ -->
                                <div id="plannedTeachingSection" class="card" style="margin-top: 15px; padding: 15px; background-color: #f8f9fa;">
                                    <h4 style="margin-top: 0px; margin-bottom: 15px; color: #495057;">å‰æœŸï¼š</h4>
                                    
                                    <!-- ç¬¬ä¸€è¡Œï¼šæ•™å­¦ã€åŠå…¬ã€åå‹¤ -->
                                    <div class="form-row" style="margin-bottom: 10px;">
                                        <div class="form-group">
                                            <label for="teachingAreaPlanned">æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_å‰æœŸ</label>
                                            <input type="text" id="teachingAreaPlanned" name="teachingAreaPlanned" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculatePlannedAreas1();">
                                        </div>
                                        <div class="form-group">
                                            <label for="officeAreaPlanned">åŠå…¬ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_å‰æœŸ</label>
                                            <input type="text" id="officeAreaPlanned" name="officeAreaPlanned" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculatePlannedAreas1();">
                                        </div>
                                        <div class="form-group">
                                            <label for="logisticsAreaPlanned">åå‹¤è¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_å‰æœŸ</label>
                                            <input type="text" id="logisticsAreaPlanned" name="logisticsAreaPlanned" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculatePlannedAreas1();">
                                        </div>
                                    </div>
                                    
                                    <!-- ç¬¬äºŒè¡Œï¼šç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯ã€å­¦ç”Ÿå®¿èˆã€å…¶ä»–ç”Ÿæ´»ç”¨æˆ¿ -->
                                    <div class="form-row" style="margin-bottom: 10px;">
                                        <div class="form-group">
                                            <label for="totalLivingAreaPlanned">ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_å‰æœŸ</label>
                                            <input type="text" id="totalLivingAreaPlanned" name="totalLivingAreaPlanned" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculatePlannedAreas1();">
                                        </div>
                                        <div class="form-group">
                                            <label for="dormitoryAreaPlanned">å…¶ä¸­ï¼šå­¦ç”Ÿå®¿èˆé¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_å‰æœŸ</label>
                                            <input type="text" id="dormitoryAreaPlanned" name="dormitoryAreaPlanned" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculatePlannedAreas1();">
                                        </div>
                                        <div class="form-group">
                                            <label for="otherLivingAreaPlanned">å…¶ä¸­ï¼šå…¶ä»–ç”Ÿæ´»ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_å‰æœŸ</label>
                                            <input type="text" id="otherLivingAreaPlanned" name="otherLivingAreaPlanned" 
                                                   class="form-control" value="0.00" readonly
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                            <small style="color: #6c757d; display: block; margin-top: 5px;">
                                                ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯-å­¦ç”Ÿå®¿èˆé¢ç§¯
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- ç¬¬ä¸‰è¡Œï¼šå»ºç­‘æ€»é¢ç§¯ -->
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="plannedBuildingArea">å»ºç­‘æ€»é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_å‰æœŸ</label>
                                            <input type="text" id="plannedBuildingArea" name="plannedBuildingArea" 
                                                   class="form-control" value="0.00" readonly
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                            <small style="color: #6c757d; display: block; margin-top: 5px; margin-bottom: 0;">
                                                æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯+åŠå…¬ç”¨æˆ¿é¢ç§¯+ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯+åå‹¤è¾…åŠ©ç”¨æˆ¿é¢ç§¯
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- æ‹Ÿå»ºæˆåœ¨å»ºé¢ç§¯ -->
                                <div id="plannedLivingSection" class="card" style="margin-top: 15px; padding: 15px; background-color: #f8f9fa;">
                                    <h4 style="margin-top: 0px; margin-bottom: 15px; color: #495057;">åœ¨å»º(å«ç«£å·¥)ï¼š</h4>
                                    
                                    <!-- ç¬¬ä¸€è¡Œï¼šæ•™å­¦ã€åŠå…¬ã€åå‹¤ -->
                                    <div class="form-row" style="margin-bottom: 10px;">
                                        <div class="form-group">
                                            <label for="teachingAreaPlanned2">æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_åœ¨å»º(å«ç«£å·¥)</label>
                                            <input type="text" id="teachingAreaPlanned2" name="teachingAreaPlanned2" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculatePlannedAreas2();">
                                        </div>
                                        <div class="form-group">
                                            <label for="officeAreaPlanned2">åŠå…¬ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_åœ¨å»º(å«ç«£å·¥)</label>
                                            <input type="text" id="officeAreaPlanned2" name="officeAreaPlanned2" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculatePlannedAreas2();">
                                        </div>
                                        <div class="form-group">
                                            <label for="logisticsAreaPlanned2">åå‹¤è¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_åœ¨å»º(å«ç«£å·¥)</label>
                                            <input type="text" id="logisticsAreaPlanned2" name="logisticsAreaPlanned2" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculatePlannedAreas2();">
                                        </div>
                                    </div>
                                    
                                    <!-- ç¬¬äºŒè¡Œï¼šç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯ã€å­¦ç”Ÿå®¿èˆã€å…¶ä»–ç”Ÿæ´»ç”¨æˆ¿ -->
                                    <div class="form-row" style="margin-bottom: 10px;">
                                        <div class="form-group">
                                            <label for="totalLivingAreaPlanned2">ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_åœ¨å»º(å«ç«£å·¥)</label>
                                            <input type="text" id="totalLivingAreaPlanned2" name="totalLivingAreaPlanned2" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculatePlannedAreas2();">
                                        </div>
                                        <div class="form-group">
                                            <label for="dormitoryAreaPlanned2">å…¶ä¸­ï¼šå­¦ç”Ÿå®¿èˆé¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_åœ¨å»º(å«ç«£å·¥)</label>
                                            <input type="text" id="dormitoryAreaPlanned2" name="dormitoryAreaPlanned2" 
                                                   class="form-control decimal-input" value="0.00" 
                                                   oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); calculatePlannedAreas2();">
                                        </div>
                                        <div class="form-group">
                                            <label for="otherLivingAreaPlanned2">å…¶ä¸­ï¼šå…¶ä»–ç”Ÿæ´»ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_åœ¨å»º(å«ç«£å·¥)</label>
                                            <input type="text" id="otherLivingAreaPlanned2" name="otherLivingAreaPlanned2" 
                                                   class="form-control" value="0.00" readonly
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                            <small style="color: #6c757d; display: block; margin-top: 5px;">
                                                ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯-å­¦ç”Ÿå®¿èˆé¢ç§¯
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- ç¬¬ä¸‰è¡Œï¼šå»ºç­‘æ€»é¢ç§¯ -->
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="plannedBuildingArea2">å»ºç­‘æ€»é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆ_åœ¨å»º(å«ç«£å·¥)</label>
                                            <input type="text" id="plannedBuildingArea2" name="plannedBuildingArea2" 
                                                   class="form-control" value="0.00" readonly
                                                   style="background-color: #e9ecef; cursor: not-allowed;">
                                            <small style="color: #6c757d; display: block; margin-top: 5px; margin-bottom: 0;">
                                                æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯+åŠå…¬ç”¨æˆ¿é¢ç§¯+ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯+åå‹¤è¾…åŠ©ç”¨æˆ¿é¢ç§¯
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 3. ç‰¹æ®Šç”¨æˆ¿è¡¥åŠ©é¢ç§¯æ¨¡å— -->
                            <div class="card" id="specialSubsidySection">
                                <h3>3. ç‰¹æ®Šç”¨æˆ¿è¡¥åŠ©é¢ç§¯</h3>
                                <p style="color: #6c757d; font-size: 14px; margin-bottom: 15px; line-height: 1.6;">
                                    è¯·å¡«å†™ï¼š<br>
                                    1. ç»å›½å®¶å‘æ”¹å§”ã€æ•™è‚²éƒ¨ã€ç§‘æŠ€éƒ¨ç­‰éƒ¨å§”æ‰¹å‡†å¹¶æŒ‚ç‰Œçš„å›½å®¶çº§é‡ç‚¹å®éªŒå®¤ã€å·¥ç¨‹ç ”ç©¶ä¸­å¿ƒã€å·¥ç¨‹æŠ€æœ¯ä¸­å¿ƒï¼›<br>
                                    2. çº³å…¥å›½å®¶"åŒä¸€æµ"å»ºè®¾ã€é«˜æ°´å¹³åœ°æ–¹é«˜æ ¡é‡ç‚¹å»ºè®¾åå•çš„å­¦ç§‘å»ºè®¾æ‰€éœ€ç”¨æˆ¿ï¼›<br>
                                    3. ç»å›½å®¶æˆ–å¸‚ç¼–åˆ¶ç®¡ç†éƒ¨é—¨æ‰¹å‡†è®¾ç«‹çš„ä¸“èŒç§‘ç ”æœºæ„æ‰€éœ€ç”¨æˆ¿ã€‚
                                </p>
                                <div id="specialSubsidiesArea">
                                    <!-- ç‰¹æ®Šè¡¥åŠ©é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                                </div>
                                <button type="button" class="btn btn-outline" onclick="addSubsidyArea()" style="background: transparent; color: #3498db; border: 2px solid #3498db; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin-top: 15px;">æ·»åŠ ç‰¹æ®Šè¡¥åŠ©</button>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                            <div class="card" id="actionButtonsSection">
                                <div style="display: flex; justify-content: flex-end; gap: 15px;">
                                    <button type="button" id="restoreButton" class="btn btn-outline" style="background: white; color: #333; border: 2px solid #ddd; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        æ¢å¤åˆ°ä¸Šä¸€æ¬¡åº•æ•°
                                    </button>
                                    <button type="button" id="updateButton" class="btn btn-primary" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        æ›´æ–°æœ¬æ¬¡åº•æ•°
                                    </button>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- å¼•å…¥å…¬å…±ç»„ä»¶ç®¡ç†å™¨ -->
    <script src="../js/componentManager.js"></script>
    
    <!-- å¼•å…¥å·¥å…·å‡½æ•° -->
    <script src="../js/utils.js"></script>
    
    <!-- å¼•å…¥APIæ¨¡å— -->
    <script src="../js/api.js"></script>
    
    <!-- å¼•å…¥è®¤è¯æ¨¡å— -->
    <script src="../js/auth.js"></script>

    <!-- å¼•å…¥å»ºç­‘é¢ç§¯ç®¡ç†æ¨¡å— -->
    <script src="../js/areaManagement.js"></script>

    <!-- é¡µé¢åˆå§‹åŒ–è„šæœ¬ -->
    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('å»ºç­‘é¢ç§¯ç®¡ç†é¡µé¢å¼€å§‹åŠ è½½...');
                
                // åˆå§‹åŒ–é¡µé¢ç»“æ„
                await ComponentManager.initPageStructure({
                    title: 'å»ºç­‘é¢ç§¯ç®¡ç†',
                    description: 'ç¬¬ä¸€æ¬¡å½•å…¥åï¼Œå½¢æˆå»ºç­‘é¢ç§¯åº•æ•°ï¼Œå¯é‡å¤ç”¨äºæµ‹ç®—ï¼Œæ— éœ€é‡å¤å½•å…¥',
                    activeMenu: 'menu-area-management'
                });
                
                // åˆå§‹åŒ–è®¤è¯æ¨¡å—
                await AuthManager.initialize();
                console.log('è®¤è¯æ¨¡å—åˆå§‹åŒ–å®Œæˆ');

                // ç«‹å³æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                const user = AuthManager.getCurrentUser();
                if (user) {
                    AuthManager.updateUserInfo(user);
                    const userName = document.getElementById('userName');
                    if (userName && userName.textContent === 'åŠ è½½ä¸­...') {
                        userName.textContent = user.real_name || user.username || 'æœªçŸ¥ç”¨æˆ·';
                    }
                    
                    // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤º/éšè—èœå•é¡¹ï¼ˆä¼ é€’å®Œæ•´çš„ç”¨æˆ·å¯¹è±¡ï¼‰
                    AuthManager.updateMenuVisibility(user);
                }
                
                // åˆå§‹åŒ–é¡µé¢å†…å®¹
                initializePage();
                
                console.log('å»ºç­‘é¢ç§¯ç®¡ç†é¡µé¢åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                // å¦‚æœæ˜¯é‡å®šå‘ç›¸å…³é”™è¯¯ï¼Œä¸åšä»»ä½•å¤„ç†ï¼ˆå·²ç»åœ¨é‡å®šå‘ä¸­ï¼‰
                if (error.message && error.message.includes('é‡å®šå‘')) {
                    console.log('æ­£åœ¨é‡å®šå‘åˆ°ç™»å½•é¡µï¼Œåœæ­¢é¡µé¢åˆå§‹åŒ–');
                    return;
                }
                // å…¶ä»–é”™è¯¯æ˜¾ç¤ºæç¤º
                showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
            }
        });

        /**
         * åˆå§‹åŒ–é¡µé¢å†…å®¹
         */
        function initializePage() {
            console.log('å»ºç­‘é¢ç§¯ç®¡ç†é¡µé¢å†…å®¹åˆå§‹åŒ–...');
            
            // åŠ è½½å­¦æ ¡åˆ—è¡¨
            loadSchoolList();
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            bindButtonEvents();
        }
        
        /**
         * ç»‘å®šæŒ‰é’®äº‹ä»¶
         */
        function bindButtonEvents() {
            // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å®Œå…¨åŠ è½½
            setTimeout(() => {
                const updateButton = document.getElementById('updateButton');
                const restoreButton = document.getElementById('restoreButton');
                
                console.log('æŸ¥æ‰¾æŒ‰é’®å…ƒç´ :', {
                    updateButton: updateButton,
                    restoreButton: restoreButton,
                    updateButtonExists: !!updateButton,
                    restoreButtonExists: !!restoreButton
                });
                
                if (updateButton) {
                    updateButton.addEventListener('click', updateBaseline);
                    console.log('âœ… æ›´æ–°åº•æ•°æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
                    
                    // æµ‹è¯•ï¼šæ·»åŠ ä¸€ä¸ªä¸´æ—¶çš„ç‚¹å‡»ç›‘å¬å™¨ç¡®è®¤äº‹ä»¶ç³»ç»Ÿæ­£å¸¸
                    updateButton.addEventListener('click', function() {
                        console.log('ğŸ”˜ æ›´æ–°æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼');
                    });
                } else {
                    console.error('âŒ æœªæ‰¾åˆ°æ›´æ–°åº•æ•°æŒ‰é’® (#updateButton)');
                }
                
                if (restoreButton) {
                    restoreButton.addEventListener('click', restoreBaseline);
                    console.log('âœ… æ¢å¤åº•æ•°æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
                    
                    // æµ‹è¯•ï¼šæ·»åŠ ä¸€ä¸ªä¸´æ—¶çš„ç‚¹å‡»ç›‘å¬å™¨ç¡®è®¤äº‹ä»¶ç³»ç»Ÿæ­£å¸¸
                    restoreButton.addEventListener('click', function() {
                        console.log('ğŸ”˜ æ¢å¤æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼');
                    });
                } else {
                    console.error('âŒ æœªæ‰¾åˆ°æ¢å¤åº•æ•°æŒ‰é’® (#restoreButton)');
                }
            }, 500);  // å»¶è¿Ÿ500msç¡®ä¿DOMåŠ è½½å®Œæˆ
        }

        /**
         * åŠ è½½å­¦æ ¡åˆ—è¡¨
         */
        async function loadSchoolList() {
            try {
                const user = AuthManager.getCurrentUser();
                const schoolSelect = document.getElementById('schoolName');
                
                if (!schoolSelect) {
                    console.error('æœªæ‰¾åˆ°å­¦æ ¡é€‰æ‹©ä¸‹æ‹‰æ¡†');
                    return;
                }

                // è·å–å­¦æ ¡æ³¨å†Œè¡¨
                const response = await fetch('/api/schools/registry', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('è·å–å­¦æ ¡åˆ—è¡¨å¤±è´¥');
                }

                const result = await response.json();
                
                if (result.success && result.data) {
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ª"è¯·é€‰æ‹©å­¦æ ¡"ï¼‰
                    schoolSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å­¦æ ¡</option>';
                    
                    // æ·»åŠ å­¦æ ¡é€‰é¡¹
                    result.data.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.school_name;
                        option.textContent = school.school_name;
                        option.dataset.schoolType = school.school_type || '';
                        schoolSelect.appendChild(option);
                    });

                    // å¦‚æœæ˜¯å­¦æ ¡ç”¨æˆ·ï¼Œå›ºå®šé€‰æ‹©å¯¹åº”å­¦æ ¡
                    if (user && user.role === 'school' && user.school_name) {
                        schoolSelect.value = user.school_name;
                        schoolSelect.disabled = true;
                        schoolSelect.style.background = '#e9ecef';
                        schoolSelect.style.cursor = 'not-allowed';
                        handleSchoolChange();
                        
                        console.log('å­¦æ ¡ç”¨æˆ·ï¼Œå·²å›ºå®šå­¦æ ¡é€‰æ‹©:', user.school_name);
                    }
                    
                    console.log('å­¦æ ¡åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œå…±', result.data.length, 'æ‰€å­¦æ ¡');
                } else {
                    throw new Error('å­¦æ ¡æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error('åŠ è½½å­¦æ ¡åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½å­¦æ ¡åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        /**
         * å¤„ç†å­¦æ ¡é€‰æ‹©å˜åŒ–
         */
        function handleSchoolChange() {
            const schoolSelect = document.getElementById('schoolName');
            const selectedOption = schoolSelect.options[schoolSelect.selectedIndex];
            const schoolTypeDisplay = document.getElementById('schoolTypeDisplay');

            if (schoolSelect.value && schoolTypeDisplay) {
                // å…ˆæ¸…ç©ºè¡¨å•æ•°æ®,é¿å…å‰ä¸€ä¸ªå­¦æ ¡çš„æ•°æ®è¢«ç»§æ‰¿
                clearFormData();
                
                // æ˜¾ç¤ºå­¦æ ¡ç±»å‹
                const schoolType = selectedOption.dataset.schoolType || '';
                schoolTypeDisplay.textContent = schoolType ? `å­¦æ ¡ç±»å‹: ${schoolType}` : '';
                schoolTypeDisplay.style.display = 'block';
                
                console.log('å·²é€‰æ‹©å­¦æ ¡:', schoolSelect.value, 'å­¦æ ¡ç±»å‹:', schoolType);
                
                // åŠ è½½è¯¥å­¦æ ¡çš„æ•°æ®æ¥æºåˆ—è¡¨
                loadDataSources(schoolSelect.value);
                
                // è‡ªåŠ¨åŠ è½½åº•æ•°æ•°æ®
                autoLoadBaseline(schoolSelect.value);
                
                // TODO: åŠ è½½è¯¥å­¦æ ¡çš„å…¶ä»–æ•°æ®
                // loadCurrentAreaData();
                // loadBaselineAreaData();
                // loadSpecialSubsidyData();
                // loadPlannedStudentsData();
            } else if (schoolTypeDisplay) {
                // éšè—å­¦æ ¡ç±»å‹
                schoolTypeDisplay.textContent = '';
                schoolTypeDisplay.style.display = 'none';
                
                // é‡ç½®æ•°æ®æ¥æºä¸‹æ‹‰æ 
                resetDataSourceSelect();
                
                // æ¸…ç©ºè¡¨å•æ•°æ®
                clearFormData();
            }
        }

        /**
         * è‡ªåŠ¨åŠ è½½åº•æ•°æ•°æ®
         */
        async function autoLoadBaseline(schoolName) {
            try {
                console.log('ğŸ“¢ è‡ªåŠ¨åŠ è½½åº•æ•°æ•°æ®:', schoolName);
                
                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                const user = AuthManager.getCurrentUser();
                const username = user?.username;

                if (!username) {
                    console.warn('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è¿‡è‡ªåŠ¨åŠ è½½åº•æ•°');
                    return;
                }

                // è°ƒç”¨APIè·å–åº•æ•°
                const response = await fetch(
                    `/api/baseline-areas?schoolName=${encodeURIComponent(schoolName)}&submitterUsername=${encodeURIComponent(username)}`,
                    { credentials: 'include' }
                );

                if (!response.ok) {
                    console.log('è¯¥å­¦æ ¡æš‚æ— åº•æ•°æ•°æ®');
                    return;
                }

                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    const baseline = result.data[0];
                    console.log('âœ… è‡ªåŠ¨åŠ è½½åº•æ•°æˆåŠŸ:', baseline);
                    
                    // å¡«å……æ•°æ®æ¥æº
                    const dataSourceElement = document.getElementById('dataSource');
                    if (dataSourceElement && baseline.data_source) {
                        // ç­‰å¾…æ•°æ®æ¥æºåˆ—è¡¨åŠ è½½å®Œæˆ
                        setTimeout(() => {
                            dataSourceElement.value = baseline.data_source;
                            console.log('âœ… å·²è‡ªåŠ¨å¡«å……æ•°æ®æ¥æº:', baseline.data_source);
                        }, 500);
                    }
                    
                    // å¡«å……ç°çŠ¶é¢ç§¯ï¼ˆç¬¬äºŒä¸ªæ•°æ®å¡ç‰‡ï¼‰
                    const currentFields = [
                        { id: 'teachingAreaCurrent2', value: baseline.current_teaching_area },
                        { id: 'officeAreaCurrent2', value: baseline.current_office_area },
                        { id: 'logisticsAreaCurrent2', value: baseline.current_logistics_area },
                        { id: 'totalLivingAreaCurrent2', value: baseline.current_living_total_area },
                        { id: 'dormitoryAreaCurrent2', value: baseline.current_dormitory_area }
                    ];
                    
                    currentFields.forEach(field => {
                        const element = document.getElementById(field.id);
                        if (element) {
                            element.value = safeToFixed(field.value);
                        }
                    });
                    
                    // å¡«å……æ‹Ÿå»ºæˆå‰æœŸ
                    const plannedFields = [
                        { id: 'teachingAreaPlanned', value: baseline.planned_teaching_area },
                        { id: 'officeAreaPlanned', value: baseline.planned_office_area },
                        { id: 'logisticsAreaPlanned', value: baseline.planned_logistics_area },
                        { id: 'totalLivingAreaPlanned', value: baseline.planned_living_total_area },
                        { id: 'dormitoryAreaPlanned', value: baseline.planned_dormitory_area }
                    ];
                    
                    plannedFields.forEach(field => {
                        const element = document.getElementById(field.id);
                        if (element) {
                            element.value = safeToFixed(field.value);
                        }
                    });
                    
                    // å¡«å……æ‹Ÿå»ºæˆåœ¨å»º
                    const underConstructionFields = [
                        { id: 'teachingAreaPlanned2', value: baseline.under_construction_teaching_area },
                        { id: 'officeAreaPlanned2', value: baseline.under_construction_office_area },
                        { id: 'logisticsAreaPlanned2', value: baseline.under_construction_logistics_area },
                        { id: 'totalLivingAreaPlanned2', value: baseline.under_construction_living_total_area },
                        { id: 'dormitoryAreaPlanned2', value: baseline.under_construction_dormitory_area }
                    ];
                    
                    underConstructionFields.forEach(field => {
                        const element = document.getElementById(field.id);
                        if (element) {
                            element.value = safeToFixed(field.value);
                        }
                    });
                    
                    // è§¦å‘è‡ªåŠ¨è®¡ç®—
                    calculateCurrentAreas2();
                    calculatePlannedAreas1();
                    calculatePlannedAreas2();
                    
                    // åŠ è½½ç‰¹æ®Šè¡¥åŠ©
                    await loadSpecialSubsidies(schoolName, username);
                    
                    console.log('âœ… åº•æ•°æ•°æ®å·²è‡ªåŠ¨åŠ è½½å®Œæˆ');
                } else {
                    console.log('â„¹ï¸ è¯¥å­¦æ ¡æš‚æ— åº•æ•°æ•°æ®');
                }

            } catch (error) {
                console.error('è‡ªåŠ¨åŠ è½½åº•æ•°å¤±è´¥:', error);
                // ä¸æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œå› ä¸ºè¿™æ˜¯è‡ªåŠ¨æ“ä½œ
            }
        }

        /**
         * æ¸…ç©ºè¡¨å•æ•°æ®
         */
        function clearFormData() {
            // æ¸…ç©ºæ‰€æœ‰é¢ç§¯è¾“å…¥æ¡†
            const areaInputs = document.querySelectorAll('input[type="number"]');
            areaInputs.forEach(input => {
                if (!input.readOnly) {
                    input.value = '0.00';
                }
            });
            
            // æ¸…ç©ºç‰¹æ®Šè¡¥åŠ©
            const container = document.getElementById('specialSubsidiesArea');
            if (container) {
                const subsidyItems = container.querySelectorAll('.subsidy-item:not(.subsidy-summary)');
                subsidyItems.forEach(item => item.remove());
                updateSubsidySummaryArea();
            }
            
            console.log('âœ… è¡¨å•æ•°æ®å·²æ¸…ç©º');
        }

        /**
         * åŠ è½½æ•°æ®æ¥æºåˆ—è¡¨
         */
        async function loadDataSources(schoolName) {
            const dataSourceSelect = document.getElementById('dataSource');
            const dataSourceHint = document.getElementById('dataSourceHint');
            
            if (!dataSourceSelect) return;
            
            try {
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                dataSourceSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
                dataSourceSelect.disabled = true;
                
                // ä»current_area_presetsè¡¨è·å–è¯¥å­¦æ ¡çš„æ‰€æœ‰æ•°æ®æ¥æº
                const response = await fetch(`/api/current-area-presets/school/${encodeURIComponent(schoolName)}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    // 404è¡¨ç¤ºè¯¥å­¦æ ¡æ²¡æœ‰è®°å½•ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µ
                    if (response.status === 404) {
                        dataSourceSelect.innerHTML = '<option value="">è¯¥å­¦æ ¡æš‚æ— æ•°æ®æ¥æº</option>';
                        if (dataSourceHint) {
                            dataSourceHint.style.display = 'none';
                        }
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // æ¸…ç©ºä¸‹æ‹‰æ¡†
                dataSourceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ•°æ®æ¥æº</option>';
                
                if (result.success && result.data && result.data.length > 0) {
                    // æå–å”¯ä¸€çš„æ•°æ®æ¥æº
                    const dataSources = [...new Set(result.data
                        .map(item => item.data_source)
                        .filter(source => source && source.trim() !== ''))];
                    
                    if (dataSources.length > 0) {
                        // æ·»åŠ æ•°æ®æ¥æºé€‰é¡¹
                        dataSources.forEach(source => {
                            const option = document.createElement('option');
                            option.value = source;
                            option.textContent = source;
                            dataSourceSelect.appendChild(option);
                        });
                        
                        dataSourceSelect.disabled = false;
                        if (dataSourceHint) {
                            dataSourceHint.style.display = 'block';
                        }
                        
                        console.log(`å·²åŠ è½½ ${dataSources.length} ä¸ªæ•°æ®æ¥æº`);
                    } else {
                        dataSourceSelect.innerHTML = '<option value="">è¯¥å­¦æ ¡æš‚æ— æ•°æ®æ¥æº</option>';
                        if (dataSourceHint) {
                            dataSourceHint.style.display = 'none';
                        }
                    }
                } else {
                    dataSourceSelect.innerHTML = '<option value="">è¯¥å­¦æ ¡æš‚æ— æ•°æ®æ¥æº</option>';
                    if (dataSourceHint) {
                        dataSourceHint.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®æ¥æºå¤±è´¥:', error);
                dataSourceSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</option>';
                if (dataSourceHint) {
                    dataSourceHint.style.display = 'none';
                }
                showMessage('åŠ è½½æ•°æ®æ¥æºå¤±è´¥: ' + error.message, 'error');
            }
        }

        /**
         * é‡ç½®æ•°æ®æ¥æºä¸‹æ‹‰æ 
         */
        function resetDataSourceSelect() {
            const dataSourceSelect = document.getElementById('dataSource');
            const dataSourceHint = document.getElementById('dataSourceHint');
            
            if (dataSourceSelect) {
                dataSourceSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å­¦æ ¡</option>';
                dataSourceSelect.disabled = true;
            }
            
            if (dataSourceHint) {
                dataSourceHint.style.display = 'none';
            }
        }

        /**
         * éªŒè¯å°æ•°è¾“å…¥ - åªå…è®¸æ•°å­—å’Œä¸€ä¸ªå°æ•°ç‚¹
         */
        function validateDecimalInput(input) {
            // ä¿å­˜å…‰æ ‡ä½ç½®
            const cursorPosition = input.selectionStart;
            const oldValue = input.value;
            
            // åªå…è®¸æ•°å­—å’Œä¸€ä¸ªå°æ•°ç‚¹
            let newValue = input.value.replace(/[^\d.]/g, '');
            
            // ç¡®ä¿åªæœ‰ä¸€ä¸ªå°æ•°ç‚¹
            const parts = newValue.split('.');
            if (parts.length > 2) {
                newValue = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // é™åˆ¶å°æ•°ç‚¹åæœ€å¤š2ä½
            if (parts.length === 2 && parts[1].length > 2) {
                newValue = parts[0] + '.' + parts[1].substring(0, 2);
            }
            
            // å¦‚æœå€¼æ”¹å˜äº†ï¼Œæ›´æ–°è¾“å…¥æ¡†
            if (newValue !== oldValue) {
                input.value = newValue;
                // æ¢å¤å…‰æ ‡ä½ç½®
                const diff = oldValue.length - newValue.length;
                input.setSelectionRange(cursorPosition - diff, cursorPosition - diff);
            }
        }

        /**
         * æ ¼å¼åŒ–å°æ•°è¾“å…¥ - å¤±ç„¦æ—¶è‡ªåŠ¨æ ¼å¼åŒ–ä¸º2ä½å°æ•°
         */
        function formatDecimalInput(input) {
            let value = input.value.trim();
            
            // å¦‚æœä¸ºç©ºï¼Œè®¾ç½®ä¸º0.00
            if (value === '' || value === '.') {
                input.value = '0.00';
                return;
            }
            
            // è½¬æ¢ä¸ºæ•°å­—å¹¶æ ¼å¼åŒ–ä¸º2ä½å°æ•°
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
                input.value = numValue.toFixed(2);
            } else {
                input.value = '0.00';
            }
        }

        /**
         * è®¡ç®—ç¬¬äºŒä¸ªæ•°æ®å¡ç‰‡ä¸­çš„è‡ªåŠ¨è®¡ç®—å­—æ®µ
         */
        function calculateCurrentAreas2() {
            try {
                // è·å–æ‰€æœ‰è¾“å…¥å€¼
                const teaching = parseFloat(document.getElementById('teachingAreaCurrent2').value) || 0;
                const office = parseFloat(document.getElementById('officeAreaCurrent2').value) || 0;
                const logistics = parseFloat(document.getElementById('logisticsAreaCurrent2').value) || 0;
                const totalLiving = parseFloat(document.getElementById('totalLivingAreaCurrent2').value) || 0;
                const dormitory = parseFloat(document.getElementById('dormitoryAreaCurrent2').value) || 0;
                
                // è®¡ç®—å…¶ä»–ç”Ÿæ´»ç”¨æˆ¿é¢ç§¯ = ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯ - å­¦ç”Ÿå®¿èˆé¢ç§¯
                const otherLiving = Math.max(0, totalLiving - dormitory);
                document.getElementById('otherLivingAreaCurrent2').value = otherLiving.toFixed(2);
                
                // è®¡ç®—å»ºç­‘æ€»é¢ç§¯ = æ•™å­¦ + åŠå…¬ + ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯ + åå‹¤
                const totalBuilding = teaching + office + totalLiving + logistics;
                document.getElementById('currentBuildingArea2').value = totalBuilding.toFixed(2);
                
            } catch (error) {
                console.error('è®¡ç®—ç°çŠ¶é¢ç§¯å¤±è´¥:', error);
            }
        }

        /**
         * è®¡ç®—æ‹Ÿå»ºæˆé¢ç§¯ç¬¬ä¸€ä¸ªå¡ç‰‡çš„è‡ªåŠ¨è®¡ç®—å­—æ®µ
         */
        function calculatePlannedAreas1() {
            try {
                // è·å–æ‰€æœ‰è¾“å…¥å€¼
                const teaching = parseFloat(document.getElementById('teachingAreaPlanned').value) || 0;
                const office = parseFloat(document.getElementById('officeAreaPlanned').value) || 0;
                const logistics = parseFloat(document.getElementById('logisticsAreaPlanned').value) || 0;
                const totalLiving = parseFloat(document.getElementById('totalLivingAreaPlanned').value) || 0;
                const dormitory = parseFloat(document.getElementById('dormitoryAreaPlanned').value) || 0;
                
                // è®¡ç®—å…¶ä»–ç”Ÿæ´»ç”¨æˆ¿é¢ç§¯ = ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯ - å­¦ç”Ÿå®¿èˆé¢ç§¯
                const otherLiving = Math.max(0, totalLiving - dormitory);
                document.getElementById('otherLivingAreaPlanned').value = otherLiving.toFixed(2);
                
                // è®¡ç®—å»ºç­‘æ€»é¢ç§¯ = æ•™å­¦ + åŠå…¬ + ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯ + åå‹¤
                const totalBuilding = teaching + office + totalLiving + logistics;
                document.getElementById('plannedBuildingArea').value = totalBuilding.toFixed(2);
                
            } catch (error) {
                console.error('è®¡ç®—æ‹Ÿå»ºæˆé¢ç§¯å¤±è´¥:', error);
            }
        }

        /**
         * è®¡ç®—æ‹Ÿå»ºæˆé¢ç§¯ç¬¬äºŒä¸ªå¡ç‰‡çš„è‡ªåŠ¨è®¡ç®—å­—æ®µ
         */
        function calculatePlannedAreas2() {
            try {
                // è·å–æ‰€æœ‰è¾“å…¥å€¼
                const teaching = parseFloat(document.getElementById('teachingAreaPlanned2').value) || 0;
                const office = parseFloat(document.getElementById('officeAreaPlanned2').value) || 0;
                const logistics = parseFloat(document.getElementById('logisticsAreaPlanned2').value) || 0;
                const totalLiving = parseFloat(document.getElementById('totalLivingAreaPlanned2').value) || 0;
                const dormitory = parseFloat(document.getElementById('dormitoryAreaPlanned2').value) || 0;
                
                // è®¡ç®—å…¶ä»–ç”Ÿæ´»ç”¨æˆ¿é¢ç§¯ = ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯ - å­¦ç”Ÿå®¿èˆé¢ç§¯
                const otherLiving = Math.max(0, totalLiving - dormitory);
                document.getElementById('otherLivingAreaPlanned2').value = otherLiving.toFixed(2);
                
                // è®¡ç®—å»ºç­‘æ€»é¢ç§¯ = æ•™å­¦ + åŠå…¬ + ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯ + åå‹¤
                const totalBuilding = teaching + office + totalLiving + logistics;
                document.getElementById('plannedBuildingArea2').value = totalBuilding.toFixed(2);
                
            } catch (error) {
                console.error('è®¡ç®—æ‹Ÿå»ºæˆé¢ç§¯å¤±è´¥:', error);
            }
        }

        /**
         * å¤„ç†æ•°æ®æ¥æºé€‰æ‹©å˜åŒ–
         */
        function handleDataSourceChange() {
            const dataSourceSelect = document.getElementById('dataSource');
            const schoolSelect = document.getElementById('schoolName');
            
            if (dataSourceSelect.value && schoolSelect.value) {
                console.log('å·²é€‰æ‹©æ•°æ®æ¥æº:', dataSourceSelect.value);
                // åŠ è½½è¯¥æ•°æ®æ¥æºçš„è¯¦ç»†æ•°æ®
                loadCurrentAreaDetails(schoolSelect.value, dataSourceSelect.value);
            } else {
                // éšè—æ•°æ®æ˜¾ç¤ºåŒºåŸŸå¹¶é‡ç½®æ‰€æœ‰å­—æ®µ
                resetCurrentAreaData();
            }
        }

        /**
         * åŠ è½½ç°çŠ¶é¢ç§¯è¯¦ç»†æ•°æ®
         */
        async function loadCurrentAreaDetails(schoolName, dataSource) {
            try {
                // è°ƒç”¨APIè·å–ç‰¹å®šå­¦æ ¡å’Œæ•°æ®æ¥æºçš„ç°çŠ¶é¢ç§¯æ•°æ®
                const response = await fetch(
                    `/api/current-area-presets/school/${encodeURIComponent(schoolName)}/source/${encodeURIComponent(dataSource)}`,
                    { credentials: 'include' }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // å¡«å……æ•°æ®åˆ°è¡¨å•å­—æ®µï¼ˆç¬¬ä¸€ä¸ªå¡ç‰‡ - åªè¯»ï¼‰
                    const data = result.data;
                    document.getElementById('teachingAreaCurrent').value = Number(data.teaching_area_current || 0).toFixed(2);
                    document.getElementById('officeAreaCurrent').value = Number(data.office_area_current || 0).toFixed(2);
                    document.getElementById('logisticsAreaCurrent').value = Number(data.logistics_area_current || 0).toFixed(2);
                    document.getElementById('totalLivingAreaCurrent').value = Number(data.total_living_area_current || 0).toFixed(2);
                    document.getElementById('dormitoryAreaCurrent').value = Number(data.dormitory_area_current || 0).toFixed(2);
                    document.getElementById('otherLivingAreaCurrent').value = Number(data.other_living_area_current || 0).toFixed(2);
                    document.getElementById('currentBuildingArea').value = Number(data.current_building_area || 0).toFixed(2);
                    
                    // åŒæ—¶å¡«å……æ•°æ®åˆ°ç¬¬äºŒä¸ªå¡ç‰‡ï¼ˆå¯ç¼–è¾‘ï¼‰- åªå¡«å……å¯ç¼–è¾‘å­—æ®µ
                    document.getElementById('teachingAreaCurrent2').value = Number(data.teaching_area_current || 0).toFixed(2);
                    document.getElementById('officeAreaCurrent2').value = Number(data.office_area_current || 0).toFixed(2);
                    document.getElementById('logisticsAreaCurrent2').value = Number(data.logistics_area_current || 0).toFixed(2);
                    document.getElementById('totalLivingAreaCurrent2').value = Number(data.total_living_area_current || 0).toFixed(2);
                    document.getElementById('dormitoryAreaCurrent2').value = Number(data.dormitory_area_current || 0).toFixed(2);
                    // ä¸ç›´æ¥å¡«å…… otherLivingAreaCurrent2 å’Œ currentBuildingArea2ï¼Œè€Œæ˜¯é€šè¿‡è®¡ç®—å¾—å‡º
                    
                    // è§¦å‘è‡ªåŠ¨è®¡ç®—
                    calculateCurrentAreas2();
                    
                    console.log('ç°çŠ¶é¢ç§¯æ•°æ®åŠ è½½æˆåŠŸ');
                } else {
                    throw new Error('æœªæ‰¾åˆ°æ•°æ®');
                }
                
            } catch (error) {
                console.error('åŠ è½½ç°çŠ¶é¢ç§¯æ•°æ®å¤±è´¥:', error);
                showMessage('åŠ è½½ç°çŠ¶é¢ç§¯æ•°æ®å¤±è´¥: ' + error.message, 'error');
                resetCurrentAreaData();
            }
        }

        /**
         * é‡ç½®ç°çŠ¶é¢ç§¯æ•°æ®æ˜¾ç¤º
         */
        function resetCurrentAreaData() {
            // é‡ç½®æ‰€æœ‰å­—æ®µä¸º0ï¼ˆæ•°æ®åŒºåŸŸå§‹ç»ˆæ˜¾ç¤ºï¼‰
            const fields = [
                'teachingAreaCurrent',
                'officeAreaCurrent',
                'logisticsAreaCurrent',
                'totalLivingAreaCurrent',
                'dormitoryAreaCurrent',
                'otherLivingAreaCurrent',
                'currentBuildingArea'
            ];
            
            // é‡ç½®ç¬¬ä¸€ä¸ªå¡ç‰‡ï¼ˆåªè¯»ï¼‰
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '0.00';
                }
            });
            
            // é‡ç½®ç¬¬äºŒä¸ªå¡ç‰‡ï¼ˆå¯ç¼–è¾‘å­—æ®µï¼‰
            const editableFields = [
                'teachingAreaCurrent2',
                'officeAreaCurrent2',
                'logisticsAreaCurrent2',
                'totalLivingAreaCurrent2',
                'dormitoryAreaCurrent2'
            ];
            
            editableFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '0.00';
                }
            });
            
            // è§¦å‘è‡ªåŠ¨è®¡ç®—æ¥æ›´æ–°è®¡ç®—å­—æ®µ
            calculateCurrentAreas2();
        }

        /**
         * æ˜¾ç¤ºæ¶ˆæ¯æç¤º
         */
        function showMessage(message, type = 'info') {
            // åˆ›å»ºæ¶ˆæ¯æç¤ºå…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                min-width: 300px;
                padding: 15px 20px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                z-index: 9999;
                animation: slideInRight 0.3s ease;
            `;
            
            const colors = {
                'success': { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
                'error': { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
                'warning': { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
                'info': { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
            };
            
            const color = colors[type] || colors.info;
            messageDiv.style.backgroundColor = color.bg;
            messageDiv.style.borderLeft = `4px solid ${color.border}`;
            messageDiv.style.color = color.text;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                messageDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        /**
         * æ·»åŠ ç‰¹æ®Šè¡¥åŠ©é¡¹
         */
        function addSubsidyArea() {
            const container = document.getElementById('specialSubsidiesArea');
            if (!container) {
                console.error('æ‰¾ä¸åˆ°ç‰¹æ®Šè¡¥åŠ©å®¹å™¨');
                return;
            }
            
            // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªè¡¥åŠ©é¡¹ï¼Œæ·»åŠ è¡¨å¤´
            if (container.children.length === 0) {
                const headerHtml = `
                    <div class="subsidy-header" style="display: flex; align-items: center; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-weight: bold; color: #495057;">
                        <div style="flex: 2; margin-right: 15px;">ç‰¹æ®Šç”¨æˆ¿è¡¥åŠ©åç§° *</div>
                        <div style="flex: 1; margin-right: 15px;">ç‰¹æ®Šç”¨æˆ¿è¡¥åŠ©å»ºç­‘é¢ç§¯(mÂ²) *</div>
                        <div style="width: 80px;">æ“ä½œ</div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', headerHtml);
            }
            
            // åˆ›å»ºæ–°çš„è¡¥åŠ©é¡¹
            const subsidyHtml = `
                <div class="subsidy-item" style="display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: white; border: 1px solid #e9ecef; border-radius: 5px;">
                    <div style="flex: 2; margin-right: 15px;">
                        <div class="form-group">
                            <input type="text" name="subsidyName[]" placeholder="ä¾‹å¦‚ï¼šé‡ç‚¹å®éªŒå®¤è¡¥åŠ©" class="form-control subsidy-name-input" style="background: white; border: 1px solid #ddd; padding: 8px; border-radius: 4px; width: 100%;">
                        </div>
                    </div>
                    <div style="flex: 1; margin-right: 15px;">
                        <div class="form-group">
                            <input type="text" name="subsidyArea[]" value="0.00" class="form-control subsidy-area-input decimal-input" oninput="validateDecimalInput(this)" onblur="formatDecimalInput(this); updateSubsidySummaryArea();" style="background: white; border: 1px solid #ddd; padding: 8px; border-radius: 4px; width: 100%;">
                        </div>
                    </div>
                    <div style="width: 80px;">
                        <button type="button" onclick="removeSubsidyArea(this)" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                    </div>
                </div>
            `;
            
            // æ’å…¥åˆ°æ±‡æ€»è¡Œä¹‹å‰
            const summaryRow = container.querySelector('.subsidy-summary');
            if (summaryRow) {
                summaryRow.insertAdjacentHTML('beforebegin', subsidyHtml);
            } else {
                container.insertAdjacentHTML('beforeend', subsidyHtml);
                // æ·»åŠ æ±‡æ€»è¡Œ
                addSubsidySummaryArea();
            }
            
            updateSubsidySummaryArea();
        }

        /**
         * åˆ é™¤ç‰¹æ®Šè¡¥åŠ©é¡¹
         */
        function removeSubsidyArea(button) {
            const subsidyItem = button.closest('.subsidy-item');
            if (subsidyItem) {
                subsidyItem.remove();
                
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è¡¥åŠ©é¡¹ï¼ˆé™¤äº†æ±‡æ€»è¡Œï¼‰
                const container = document.getElementById('specialSubsidiesArea');
                const remainingItems = container.querySelectorAll('.subsidy-item:not(.subsidy-summary)');
                
                if (remainingItems.length === 0) {
                    // å¦‚æœæ²¡æœ‰è¡¥åŠ©é¡¹äº†ï¼Œæ¸…ç©ºæ•´ä¸ªå®¹å™¨ï¼ˆåŒ…æ‹¬è¡¨å¤´å’Œæ±‡æ€»è¡Œï¼‰
                    container.innerHTML = '';
                } else {
                    updateSubsidySummaryArea();
                }
            }
        }

        /**
         * æ·»åŠ è¡¥åŠ©æ±‡æ€»è¡Œ
         */
        function addSubsidySummaryArea() {
            const container = document.getElementById('specialSubsidiesArea');
            if (!container || container.querySelector('.subsidy-summary')) return;
            
            const summaryHtml = `
                <div class="subsidy-summary subsidy-item" style="display: flex; align-items: center; margin-top: 15px; padding: 10px; background: transparent; border: none; border-radius: 5px; font-weight: bold;">
                    <div style="flex: 2; margin-right: 15px;">
                        <div style="margin-bottom: 5px; color: #495057; font-size: 14px;">ç‰¹æ®Šç”¨æˆ¿è¡¥åŠ©æ•°é‡</div>
                        <input type="text" id="subsidyTotalCountArea" readonly class="form-control calculated-field" value="0" style="background: #f5f5f5; border: none; padding: 8px; border-radius: 4px; width: 100%; font-weight: bold; text-align: center;">
                    </div>
                    <div style="flex: 1; margin-right: 15px;">
                        <div style="margin-bottom: 5px; color: #495057; font-size: 14px;">ç‰¹æ®Šç”¨æˆ¿è¡¥åŠ©å»ºç­‘æ€»é¢ç§¯(mÂ²)</div>
                        <input type="text" id="subsidyTotalAreaSum" readonly class="form-control calculated-field" value="0.00" style="background: #f5f5f5; border: none; padding: 8px; border-radius: 4px; width: 100%; font-weight: bold; text-align: center;">
                    </div>
                    <div style="width: 80px;"></div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', summaryHtml);
        }

        /**
         * æ›´æ–°è¡¥åŠ©æ±‡æ€»
         */
        function updateSubsidySummaryArea() {
            const container = document.getElementById('specialSubsidiesArea');
            if (!container) return;
            
            const subsidyInputs = container.querySelectorAll('input[name="subsidyArea[]"]');
            let total = 0;
            let count = 0;
            
            subsidyInputs.forEach((input) => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            // è®¡ç®—æ‰€æœ‰æ·»åŠ çš„è¡¥åŠ©é¡¹ç›®æ•°é‡
            count = subsidyInputs.length;
            
            // è·å–æ±‡æ€»è¡Œ
            const summaryRow = container.querySelector('.subsidy-summary');
            
            // å¦‚æœæ²¡æœ‰è¡¥åŠ©é¡¹,éšè—æ±‡æ€»è¡Œ;æœ‰è¡¥åŠ©é¡¹åˆ™æ˜¾ç¤ºå¹¶æ›´æ–°æ•°æ®
            if (count === 0) {
                if (summaryRow) {
                    summaryRow.style.display = 'none';
                }
            } else {
                if (summaryRow) {
                    summaryRow.style.display = 'flex';
                }
                
                const totalInput = document.getElementById('subsidyTotalAreaSum');
                if (totalInput) {
                    totalInput.value = total.toFixed(2);
                }
                
                const countInput = document.getElementById('subsidyTotalCountArea');
                if (countInput) {
                    countInput.value = count;
                }
            }
        }

        /**
         * æ ¼å¼åŒ–è¡¥åŠ©é¢ç§¯è¾“å…¥
         */
        function formatSubsidyArea(input) {
            formatDecimalInput(input);
        }

        /**
         * æ”¶é›†é¡µé¢æ‰€æœ‰æ•°æ®
         */
        function collectPageData() {
            const schoolName = document.getElementById('schoolName').value;
            
            if (!schoolName) {
                showMessage('è¯·å…ˆé€‰æ‹©å­¦æ ¡', 'warning');
                return null;
            }

            // è·å–æ•°æ®æ¥æº
            const dataSource = document.getElementById('dataSource').value || 'è‡ªå¡«';

            // 1. æ”¶é›†ç°çŠ¶é¢ç§¯æ•°æ®ï¼ˆç¬¬äºŒä¸ªæ•°æ®å¡ç‰‡ - å¯ç¼–è¾‘çš„ï¼‰
            const currentData = {
                teaching_area: parseFloat(document.getElementById('teachingAreaCurrent2')?.value) || 0,
                office_area: parseFloat(document.getElementById('officeAreaCurrent2')?.value) || 0,
                logistics_area: parseFloat(document.getElementById('logisticsAreaCurrent2')?.value) || 0,
                living_total_area: parseFloat(document.getElementById('totalLivingAreaCurrent2')?.value) || 0,
                dormitory_area: parseFloat(document.getElementById('dormitoryAreaCurrent2')?.value) || 0
            };

            // 2. æ”¶é›†æ‹Ÿå»ºæˆå‰æœŸæ•°æ®ï¼ˆç¬¬ä¸€ä¸ªå¡ç‰‡ - æ²¡æœ‰æ•°å­—åç¼€ï¼‰
            const plannedData = {
                teaching_area: parseFloat(document.getElementById('teachingAreaPlanned')?.value) || 0,
                office_area: parseFloat(document.getElementById('officeAreaPlanned')?.value) || 0,
                logistics_area: parseFloat(document.getElementById('logisticsAreaPlanned')?.value) || 0,
                living_total_area: parseFloat(document.getElementById('totalLivingAreaPlanned')?.value) || 0,
                dormitory_area: parseFloat(document.getElementById('dormitoryAreaPlanned')?.value) || 0
            };

            // 3. æ”¶é›†æ‹Ÿå»ºæˆåœ¨å»ºæ•°æ®ï¼ˆç¬¬äºŒä¸ªå¡ç‰‡ - åç¼€2ï¼‰
            const underConstructionData = {
                teaching_area: parseFloat(document.getElementById('teachingAreaPlanned2')?.value) || 0,
                office_area: parseFloat(document.getElementById('officeAreaPlanned2')?.value) || 0,
                logistics_area: parseFloat(document.getElementById('logisticsAreaPlanned2')?.value) || 0,
                living_total_area: parseFloat(document.getElementById('totalLivingAreaPlanned2')?.value) || 0,
                dormitory_area: parseFloat(document.getElementById('dormitoryAreaPlanned2')?.value) || 0
            };

            // 4. æ”¶é›†ç‰¹æ®Šè¡¥åŠ©æ•°æ®
            const specialSubsidies = [];
            const subsidyItems = document.querySelectorAll('#specialSubsidiesArea .subsidy-item');
            
            subsidyItems.forEach(item => {
                const nameInput = item.querySelector('input[name="subsidyName[]"]');
                const areaInput = item.querySelector('input[name="subsidyArea[]"]');
                
                const name = nameInput?.value?.trim();
                const area = parseFloat(areaInput?.value) || 0;
                
                if (name) {  // åªä¿å­˜æœ‰åç§°çš„è¡¥åŠ©é¡¹
                    specialSubsidies.push({
                        subsidy_name: name,
                        subsidy_area: area
                    });
                }
            });

            return {
                schoolName,
                baselineData: {
                    data_source: dataSource,
                    current_teaching_area: currentData.teaching_area,
                    current_office_area: currentData.office_area,
                    current_logistics_area: currentData.logistics_area,
                    current_living_total_area: currentData.living_total_area,
                    current_dormitory_area: currentData.dormitory_area,
                    planned_teaching_area: plannedData.teaching_area,
                    planned_office_area: plannedData.office_area,
                    planned_logistics_area: plannedData.logistics_area,
                    planned_living_total_area: plannedData.living_total_area,
                    planned_dormitory_area: plannedData.dormitory_area,
                    under_construction_teaching_area: underConstructionData.teaching_area,
                    under_construction_office_area: underConstructionData.office_area,
                    under_construction_logistics_area: underConstructionData.logistics_area,
                    under_construction_living_total_area: underConstructionData.living_total_area,
                    under_construction_dormitory_area: underConstructionData.dormitory_area
                },
                specialSubsidies
            };
        }

        /**
         * éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
         * @returns {Object|null} - å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å› {valid: false, message: string, elementId: string}ï¼›å¦‚æœæˆåŠŸï¼Œè¿”å› {valid: true}
         */
        function validateBaselineData() {
            // 1. æ£€æŸ¥æ•°æ®æ¥æºæ˜¯å¦å·²é€‰æ‹©
            const dataSource = document.getElementById('dataSource').value;
            if (!dataSource || dataSource === '') {
                return {
                    valid: false,
                    message: 'è¯·é€‰æ‹©"æ•°æ®æ¥æº_å»ºç­‘é¢ç§¯(ã¡)_ç°çŠ¶"',
                    elementId: 'dataSource'
                };
            }

            // 2. æ£€æŸ¥æ‰€æœ‰é¢ç§¯å€¼æ˜¯å¦ä¸ºè´Ÿæ•°
            const areaFields = [
                // ç°çŠ¶é¢ç§¯
                { id: 'teachingAreaCurrent2', label: 'æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶' },
                { id: 'officeAreaCurrent2', label: 'åŠå…¬åŠç®¡ç†ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶' },
                { id: 'logisticsAreaCurrent2', label: 'ç”Ÿæ´»ç¦åˆ©åŠå…¶ä»–ç”¨æˆ¿é¢ç§¯(ã¡)_ç°çŠ¶' },
                { id: 'totalLivingAreaCurrent2', label: 'å„éƒ¨åˆ†ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯(ã¡)_ç°çŠ¶' },
                { id: 'dormitoryAreaCurrent2', label: 'å…¶ä¸­ï¼šå­¦ç”Ÿå®¿èˆé¢ç§¯(ã¡)_ç°çŠ¶' },
                // æ‹Ÿå»ºæˆå‰æœŸ
                { id: 'teachingAreaPlanned', label: 'æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆå‰æœŸ' },
                { id: 'officeAreaPlanned', label: 'åŠå…¬åŠç®¡ç†ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆå‰æœŸ' },
                { id: 'logisticsAreaPlanned', label: 'ç”Ÿæ´»ç¦åˆ©åŠå…¶ä»–ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆå‰æœŸ' },
                { id: 'totalLivingAreaPlanned', label: 'å„éƒ¨åˆ†ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆå‰æœŸ' },
                { id: 'dormitoryAreaPlanned', label: 'å…¶ä¸­ï¼šå­¦ç”Ÿå®¿èˆé¢ç§¯(ã¡)_æ‹Ÿå»ºæˆå‰æœŸ' },
                // æ‹Ÿå»ºæˆåœ¨å»º
                { id: 'teachingAreaPlanned2', label: 'æ•™å­¦åŠè¾…åŠ©ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆåœ¨å»º' },
                { id: 'officeAreaPlanned2', label: 'åŠå…¬åŠç®¡ç†ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆåœ¨å»º' },
                { id: 'logisticsAreaPlanned2', label: 'ç”Ÿæ´»ç¦åˆ©åŠå…¶ä»–ç”¨æˆ¿é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆåœ¨å»º' },
                { id: 'totalLivingAreaPlanned2', label: 'å„éƒ¨åˆ†ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯(ã¡)_æ‹Ÿå»ºæˆåœ¨å»º' },
                { id: 'dormitoryAreaPlanned2', label: 'å…¶ä¸­ï¼šå­¦ç”Ÿå®¿èˆé¢ç§¯(ã¡)_æ‹Ÿå»ºæˆåœ¨å»º' }
            ];

            for (const field of areaFields) {
                const element = document.getElementById(field.id);
                if (element) {
                    const value = parseFloat(element.value) || 0;
                    if (value < 0) {
                        return {
                            valid: false,
                            message: `"${field.label}"çš„å€¼ä¸èƒ½ä¸ºè´Ÿæ•°`,
                            elementId: field.id
                        };
                    }
                }
            }

            // 3. æ£€æŸ¥å„éƒ¨åˆ†ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯æ˜¯å¦å°äºå­¦ç”Ÿå®¿èˆé¢ç§¯ï¼ˆä¸‰ä¸ªæ•°æ®é›†ï¼‰
            const livingRoomChecks = [
                { 
                    totalId: 'totalLivingAreaCurrent2', 
                    dormitoryId: 'dormitoryAreaCurrent2',
                    label: 'ç°çŠ¶'
                },
                { 
                    totalId: 'totalLivingAreaPlanned', 
                    dormitoryId: 'dormitoryAreaPlanned',
                    label: 'æ‹Ÿå»ºæˆå‰æœŸ'
                },
                { 
                    totalId: 'totalLivingAreaPlanned2', 
                    dormitoryId: 'dormitoryAreaPlanned2',
                    label: 'æ‹Ÿå»ºæˆåœ¨å»º'
                }
            ];

            for (const check of livingRoomChecks) {
                const totalElement = document.getElementById(check.totalId);
                const dormitoryElement = document.getElementById(check.dormitoryId);
                
                if (totalElement && dormitoryElement) {
                    const totalArea = parseFloat(totalElement.value) || 0;
                    const dormitoryArea = parseFloat(dormitoryElement.value) || 0;
                    
                    if (totalArea < dormitoryArea) {
                        return {
                            valid: false,
                            message: `"${check.label}"çš„å„éƒ¨åˆ†ç”Ÿæ´»ç”¨æˆ¿æ€»é¢ç§¯(${totalArea.toFixed(2)}ã¡)ä¸èƒ½å°äºå­¦ç”Ÿå®¿èˆé¢ç§¯(${dormitoryArea.toFixed(2)}ã¡)`,
                            elementId: check.totalId
                        };
                    }
                }
            }

            // 4. æ£€æŸ¥ç‰¹æ®Šç”¨æˆ¿è¡¥åŠ©ï¼ˆæ’é™¤æ±‡æ€»è¡Œï¼‰
            const subsidyItems = document.querySelectorAll('#specialSubsidiesArea .subsidy-item:not(.subsidy-summary)');
            let subsidyIndex = 0;
            
            for (const item of subsidyItems) {
                subsidyIndex++;
                const nameInput = item.querySelector('input[name="subsidyName[]"]');
                const areaInput = item.querySelector('input[name="subsidyArea[]"]');
                
                if (nameInput && areaInput) {
                    const name = nameInput.value?.trim();
                    const areaValue = areaInput.value?.trim();
                    const area = parseFloat(areaValue);
                    
                    // æ£€æŸ¥æ˜¯å¦å¡«å†™
                    const hasName = name && name !== '';
                    const hasArea = areaValue && areaValue !== '' && areaValue !== '0' && areaValue !== '0.00';
                    
                    // ä¼˜å…ˆæ£€æŸ¥åç§°æ˜¯å¦ä¸ºç©ºï¼ˆåªè¦æœ‰è¾“å…¥è¡Œå­˜åœ¨å°±å¿…é¡»å¡«å†™åç§°ï¼‰
                    if (!hasName) {
                        return {
                            valid: false,
                            message: `ç¬¬${subsidyIndex}ä¸ªç‰¹æ®Šç”¨æˆ¿è¡¥åŠ©çš„åç§°ä¸èƒ½ä¸ºç©º`,
                            element: nameInput
                        };
                    }
                    
                    // å¦‚æœæœ‰åç§°ä½†æ²¡æœ‰é¢ç§¯
                    if (hasName && !hasArea) {
                        return {
                            valid: false,
                            message: `ç¬¬${subsidyIndex}ä¸ªç‰¹æ®Šç”¨æˆ¿è¡¥åŠ©"${name}"çš„å»ºç­‘é¢ç§¯ä¸èƒ½ä¸ºç©º`,
                            element: areaInput
                        };
                    }
                    
                    // å¦‚æœéƒ½å¡«å†™äº†ï¼Œæ£€æŸ¥é¢ç§¯æ˜¯å¦ä¸ºè´Ÿæ•°
                    if (hasName && hasArea && area < 0) {
                        return {
                            valid: false,
                            message: `ç‰¹æ®Šç”¨æˆ¿è¡¥åŠ©"${name}"çš„å»ºç­‘é¢ç§¯ä¸èƒ½ä¸ºè´Ÿæ•°`,
                            element: areaInput
                        };
                    }
                }
            }

            return { valid: true };
        }

        /**
         * æ›´æ–°æœ¬æ¬¡åº•æ•°
         */
        async function updateBaseline() {
            console.log('ğŸ“¢ updateBaseline å‡½æ•°è¢«è°ƒç”¨');
            try {
                // éªŒè¯æ•°æ®
                const validation = validateBaselineData();
                if (!validation.valid) {
                    // è·³è½¬åˆ°æœ‰é—®é¢˜çš„å…ƒç´ å¹¶é«˜äº®æ˜¾ç¤º
                    // æ”¯æŒä¸¤ç§æ–¹å¼ï¼šé€šè¿‡ elementId æŸ¥æ‰¾æˆ–ç›´æ¥ä½¿ç”¨ element
                    const element = validation.element || document.getElementById(validation.elementId);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.focus();
                        
                        // æ·»åŠ çº¢è‰²è¾¹æ¡†é«˜äº®
                        element.style.border = '2px solid red';
                        element.style.boxShadow = '0 0 5px rgba(255, 0, 0, 0.5)';
                        
                        // 3ç§’åç§»é™¤é«˜äº®
                        setTimeout(() => {
                            element.style.border = '';
                            element.style.boxShadow = '';
                        }, 3000);
                    }
                    
                    showMessage(validation.message, 'error');
                    return;
                }

                // æ”¶é›†æ•°æ®
                const data = collectPageData();
                if (!data) return;

                // ç¡®è®¤æ“ä½œ
                const confirmMsg = `ç¡®å®šè¦æ›´æ–°åº•æ•°å—ï¼Ÿ\n\nè¿™å°†è¦†ç›–æ‚¨ä¹‹å‰ä¸º"${data.schoolName}"æäº¤çš„åº•æ•°æ•°æ®ã€‚`;

                if (!confirm(confirmMsg)) {
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const updateButton = document.getElementById('updateButton');
                const originalText = updateButton.textContent;
                updateButton.textContent = 'ä¿å­˜ä¸­...';
                updateButton.disabled = true;

                // è°ƒç”¨API
                const response = await fetch('/api/baseline-areas/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('åº•æ•°æ›´æ–°æˆåŠŸï¼', 'success');
                } else {
                    throw new Error(result.message || 'æ›´æ–°å¤±è´¥');
                }

            } catch (error) {
                console.error('æ›´æ–°åº•æ•°å¤±è´¥:', error);
                showMessage('æ›´æ–°åº•æ•°å¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const updateButton = document.getElementById('updateButton');
                updateButton.textContent = 'æ›´æ–°æœ¬æ¬¡åº•æ•°';
                updateButton.disabled = false;
            }
        }

        /**
         * å®‰å…¨åœ°å°†å€¼è½¬æ¢ä¸ºå¸¦ä¸¤ä½å°æ•°çš„å­—ç¬¦ä¸²
         * @param {*} value - è¦è½¬æ¢çš„å€¼
         * @returns {string} - æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼Œå¦‚ "0.00"
         */
        function safeToFixed(value, decimals = 2) {
            if (value === null || value === undefined || value === '') {
                return '0.00';
            }
            const num = parseFloat(value);
            if (isNaN(num)) {
                return '0.00';
            }
            return num.toFixed(decimals);
        }

        /**
         * æ¢å¤åˆ°ä¸Šä¸€æ¬¡åº•æ•°
         */
        async function restoreBaseline() {
            console.log('ğŸ“¢ restoreBaseline å‡½æ•°è¢«è°ƒç”¨');
            try {
                const schoolName = document.getElementById('schoolName').value;
                
                if (!schoolName) {
                    showMessage('è¯·å…ˆé€‰æ‹©å­¦æ ¡', 'warning');
                    return;
                }

                // ç¡®è®¤æ“ä½œ
                if (!confirm('ç¡®å®šè¦æ¢å¤åˆ°ä¸Šä¸€æ¬¡ä¿å­˜çš„åº•æ•°å—ï¼Ÿ\n\nå½“å‰é¡µé¢çš„æœªä¿å­˜ä¿®æ”¹å°†è¢«ä¸¢å¼ƒã€‚')) {
                    return;
                }

                // è·å–å½“å‰ç”¨æˆ·çš„åº•æ•°æ•°æ®
                const user = AuthManager.getCurrentUser();
                const username = user?.username;

                if (!username) {
                    showMessage('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯', 'error');
                    return;
                }

                showMessage('æ­£åœ¨åŠ è½½åº•æ•°æ•°æ®...', 'info');

                // è°ƒç”¨APIè·å–åº•æ•°
                const response = await fetch(
                    `/api/baseline-areas?schoolName=${encodeURIComponent(schoolName)}&submitterUsername=${encodeURIComponent(username)}`,
                    { credentials: 'include' }
                );

                if (!response.ok) {
                    throw new Error('è·å–åº•æ•°æ•°æ®å¤±è´¥');
                }

                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    const baseline = result.data[0];
                    
                    console.log('ğŸ“Š åº•æ•°æ•°æ®:', baseline);
                    console.log('ğŸ“Š æ•°æ®ç±»å‹æ£€æŸ¥:', {
                        current_teaching_area: typeof baseline.current_teaching_area,
                        value: baseline.current_teaching_area
                    });
                    
                    // å¡«å……æ•°æ®æ¥æº
                    const dataSourceElement = document.getElementById('dataSource');
                    if (dataSourceElement && baseline.data_source) {
                        dataSourceElement.value = baseline.data_source;
                        console.log('âœ… å·²å¡«å……æ•°æ®æ¥æº:', baseline.data_source);
                    } else {
                        console.warn('âš ï¸ æœªæ‰¾åˆ°æ•°æ®æ¥æºå…ƒç´ æˆ–æ•°æ®ä¸ºç©º');
                    }
                    
                    // å¡«å……ç°çŠ¶é¢ç§¯ï¼ˆç¬¬äºŒä¸ªæ•°æ®å¡ç‰‡ï¼‰
                    const currentFields = [
                        { id: 'teachingAreaCurrent2', value: baseline.current_teaching_area },
                        { id: 'officeAreaCurrent2', value: baseline.current_office_area },
                        { id: 'logisticsAreaCurrent2', value: baseline.current_logistics_area },
                        { id: 'totalLivingAreaCurrent2', value: baseline.current_living_total_area },
                        { id: 'dormitoryAreaCurrent2', value: baseline.current_dormitory_area }
                    ];
                    
                    currentFields.forEach(field => {
                        const element = document.getElementById(field.id);
                        if (element) {
                            element.value = safeToFixed(field.value);
                        } else {
                            console.error(`âŒ æœªæ‰¾åˆ°å…ƒç´ : ${field.id}`);
                        }
                    });
                    
                    // å¡«å……æ‹Ÿå»ºæˆå‰æœŸï¼ˆç¬¬ä¸€ä¸ªå¡ç‰‡ - æ²¡æœ‰æ•°å­—åç¼€ï¼‰
                    const plannedFields = [
                        { id: 'teachingAreaPlanned', value: baseline.planned_teaching_area },
                        { id: 'officeAreaPlanned', value: baseline.planned_office_area },
                        { id: 'logisticsAreaPlanned', value: baseline.planned_logistics_area },
                        { id: 'totalLivingAreaPlanned', value: baseline.planned_living_total_area },
                        { id: 'dormitoryAreaPlanned', value: baseline.planned_dormitory_area }
                    ];
                    
                    plannedFields.forEach(field => {
                        const element = document.getElementById(field.id);
                        if (element) {
                            element.value = safeToFixed(field.value);
                        } else {
                            console.error(`âŒ æœªæ‰¾åˆ°å…ƒç´ : ${field.id}`);
                        }
                    });
                    
                    // å¡«å……æ‹Ÿå»ºæˆåœ¨å»ºï¼ˆç¬¬äºŒä¸ªå¡ç‰‡ - åç¼€2ï¼‰
                    const underConstructionFields = [
                        { id: 'teachingAreaPlanned2', value: baseline.under_construction_teaching_area },
                        { id: 'officeAreaPlanned2', value: baseline.under_construction_office_area },
                        { id: 'logisticsAreaPlanned2', value: baseline.under_construction_logistics_area },
                        { id: 'totalLivingAreaPlanned2', value: baseline.under_construction_living_total_area },
                        { id: 'dormitoryAreaPlanned2', value: baseline.under_construction_dormitory_area }
                    ];
                    
                    underConstructionFields.forEach(field => {
                        const element = document.getElementById(field.id);
                        if (element) {
                            element.value = safeToFixed(field.value);
                        } else {
                            console.error(`âŒ æœªæ‰¾åˆ°å…ƒç´ : ${field.id}`);
                        }
                    });
                    
                    // è§¦å‘è‡ªåŠ¨è®¡ç®—
                    calculateCurrentAreas2();
                    calculatePlannedAreas1();
                    calculatePlannedAreas2();
                    
                    // åŠ è½½ç‰¹æ®Šè¡¥åŠ©
                    await loadSpecialSubsidies(schoolName, username);
                    
                    showMessage('å·²æ¢å¤åˆ°ä¸Šä¸€æ¬¡ä¿å­˜çš„åº•æ•°', 'success');
                } else {
                    showMessage('æœªæ‰¾åˆ°å·²ä¿å­˜çš„åº•æ•°æ•°æ®', 'warning');
                }

            } catch (error) {
                console.error('æ¢å¤åº•æ•°å¤±è´¥:', error);
                showMessage('æ¢å¤åº•æ•°å¤±è´¥: ' + error.message, 'error');
            }
        }

        /**
         * åŠ è½½ç‰¹æ®Šè¡¥åŠ©æ•°æ®
         */
        async function loadSpecialSubsidies(schoolName, username) {
            try {
                console.log('ğŸ“¢ loadSpecialSubsidies è¢«è°ƒç”¨', { schoolName, username });
                
                const response = await fetch(
                    `/api/special-subsidy-baselines?schoolName=${encodeURIComponent(schoolName)}&submitterUsername=${encodeURIComponent(username)}`,
                    { credentials: 'include' }
                );

                if (!response.ok) {
                    throw new Error('è·å–ç‰¹æ®Šè¡¥åŠ©æ•°æ®å¤±è´¥');
                }

                const result = await response.json();
                console.log('ğŸ“Š ç‰¹æ®Šè¡¥åŠ©APIè¿”å›æ•°æ®:', result);

                // æ¸…ç©ºç°æœ‰è¡¥åŠ©é¡¹ï¼ˆä¿ç•™æ±‡æ€»è¡Œï¼‰
                const container = document.getElementById('specialSubsidiesArea');
                const subsidyItems = container.querySelectorAll('.subsidy-item:not(.subsidy-summary)');
                subsidyItems.forEach(item => item.remove());

                if (result.success && result.data && result.data.length > 0) {
                    console.log(`âœ… æ‰¾åˆ° ${result.data.length} ä¸ªç‰¹æ®Šè¡¥åŠ©é¡¹`);
                    
                    // æ·»åŠ æ¯ä¸ªè¡¥åŠ©é¡¹
                    result.data.forEach((subsidy, index) => {
                        console.log(`æ·»åŠ ç¬¬ ${index + 1} ä¸ªè¡¥åŠ©é¡¹:`, subsidy);
                        addSubsidyArea();
                        
                        // å¡«å……æœ€åä¸€ä¸ªæ·»åŠ çš„è¡¥åŠ©é¡¹ï¼ˆæ’é™¤æ±‡æ€»è¡Œï¼‰
                        const items = container.querySelectorAll('.subsidy-item:not(.subsidy-summary)');
                        const lastItem = items[items.length - 1];
                        
                        if (lastItem) {
                            const nameInput = lastItem.querySelector('input[name="subsidyName[]"]');
                            const areaInput = lastItem.querySelector('input[name="subsidyArea[]"]');
                            
                            if (nameInput) {
                                nameInput.value = subsidy.subsidy_name || '';
                                console.log(`  âœ… å¡«å……åç§°: ${subsidy.subsidy_name}`);
                            } else {
                                console.error('  âŒ æœªæ‰¾åˆ°åç§°è¾“å…¥æ¡†');
                            }
                            
                            if (areaInput) {
                                areaInput.value = safeToFixed(subsidy.subsidy_area);
                                console.log(`  âœ… å¡«å……é¢ç§¯: ${subsidy.subsidy_area}`);
                            } else {
                                console.error('  âŒ æœªæ‰¾åˆ°é¢ç§¯è¾“å…¥æ¡†');
                            }
                        } else {
                            console.error('  âŒ æœªæ‰¾åˆ°æœ€åä¸€ä¸ªè¡¥åŠ©é¡¹');
                        }
                    });
                    
                    // æ›´æ–°æ±‡æ€»
                    updateSubsidySummaryArea();
                } else {
                    console.log('â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°ç‰¹æ®Šè¡¥åŠ©æ•°æ®');
                }

            } catch (error) {
                console.error('åŠ è½½ç‰¹æ®Šè¡¥åŠ©å¤±è´¥:', error);
                throw error;
            }
        }

        // ==========================================
        // è°ƒè¯•è¾…åŠ©å‡½æ•°
        // ==========================================
        
        /**
         * æµ‹è¯•æŒ‰é’®ç»‘å®šï¼ˆå¯åœ¨æµè§ˆå™¨æ§åˆ¶å°è°ƒç”¨ï¼‰
         */
        window.testButtons = function() {
            console.log('=== æŒ‰é’®æµ‹è¯• ===');
            const updateButton = document.getElementById('updateButton');
            const restoreButton = document.getElementById('restoreButton');
            
            console.log('updateButton:', updateButton);
            console.log('restoreButton:', restoreButton);
            
            if (updateButton) {
                console.log('âœ… æ‰¾åˆ°æ›´æ–°æŒ‰é’®ï¼Œå°è¯•æ‰‹åŠ¨è§¦å‘ç‚¹å‡»...');
                updateButton.click();
            } else {
                console.error('âŒ æœªæ‰¾åˆ°æ›´æ–°æŒ‰é’®');
            }
        };
        
        /**
         * æ‰‹åŠ¨æµ‹è¯•æ›´æ–°åº•æ•°å‡½æ•°
         */
        window.testUpdateBaseline = function() {
            console.log('æ‰‹åŠ¨è°ƒç”¨ updateBaseline...');
            updateBaseline();
        };
        
        /**
         * æ‰‹åŠ¨æµ‹è¯•æ¢å¤åº•æ•°å‡½æ•°
         */
        window.testRestoreBaseline = function() {
            console.log('æ‰‹åŠ¨è°ƒç”¨ restoreBaseline...');
            restoreBaseline();
        };


    </script>
</body>
</html>
