<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高校测算 - 高校建筑面积缺口计算器</title>
    <!-- 引入模块化CSS样式 -->
    <link rel="stylesheet" href="../css/main.css">
    <style>
        /* 页面专用样式 */
        .new-calculation-container {
            width: 100%;
            padding: 20px;
        }
        
        .calculation-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .calculation-card h3 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
        }
        
        .input-field label {
            color: #495057;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .input-field input,
        .input-field select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .input-field input:focus,
        .input-field select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .input-field input[readonly] {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn-calculate {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-reset {
            background: white;
            color: #3498db;
            border: 2px solid #3498db;
            padding: 12px 40px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-reset:hover {
            background: #3498db;
            color: white;
        }
        
        .result-section {
            display: none;
            margin-top: 30px;
        }
        
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .result-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-item {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .result-item-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .result-item-value {
            font-size: 28px;
            font-weight: 700;
        }
        
        /* 两列卡片布局 */
        .cards-row {
            display: grid;
            grid-template-columns: 0.8fr 1.2fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .data-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: visible;
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 400px;
            border: 1px solid #e0e0e0;
        }
        
        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .card-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            border: none;
            padding: 0;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .card-body p {
            margin: 0;
            color: #495057;
            line-height: 1.6;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .cards-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* 左侧卡片内容样式 */
        .card-content {
            padding: 30px;
            overflow: visible;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        /* 学校类型显示 */
        #schoolTypeDisplayNew {
            display: block;
            color: #1976d2;
            font-size: 13px;
            margin-top: 8px;
        }
        
        /* 规划表格样式 */
        .planning-table-container {
            margin-top: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: visible;
            position: relative;
            z-index: 1;
        }
        
        .planning-table {
            width: 100%;
            border-collapse: collapse;
            overflow: visible;
        }
        
        .planning-table thead {
            background: #f5f5f5;
            position: relative;
            z-index: 10;
        }
        
        .planning-table th {
            padding: 12px 15px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            position: relative;
            overflow: visible;
        }
        
        .planning-table th:nth-child(1) {
            width: 43%;
        }
        
        .planning-table th:nth-child(2) {
            width: 43%;
        }
        
        .planning-table th:nth-child(3) {
            width: 14%;
        }
        
        .planning-table tbody td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        
        .planning-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .planning-table tbody tr:hover {
            background: #fafafa;
        }
        
        .info-icon {
            display: inline-block;
            margin-left: 8px;
            color: #1976d2;
            font-size: 16px;
            cursor: help;
            vertical-align: middle;
            position: relative;
            z-index: 1000;
        }
        
        .info-icon:hover {
            color: #1565c0;
        }
        
        .info-icon::before {
            position: relative;
            z-index: 1001;
        }
        
        /* 确保 title 提示框在最上层 */
        .planning-table-container {
            position: relative;
            z-index: 1;
        }
        
        /* 自定义级联选择器 */
        .custom-cascade-select {
            position: relative;
            width: 100%;
        }
        
        .custom-cascade-select .select-display {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .custom-cascade-select .select-display:hover {
            border-color: #1976d2;
        }
        
        .custom-cascade-select .select-display.disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            color: #999;
        }
        
        .custom-cascade-select .select-display::after {
            content: '▼';
            font-size: 12px;
            color: #666;
        }
        
        /* 下拉面板 */
        .custom-cascade-select .dropdown-panel {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
            max-height: 300px;
            overflow: hidden;
        }
        
        .custom-cascade-select .dropdown-panel.show {
            display: flex;
        }
        
        /* 左侧年份列表 */
        .custom-cascade-select .year-list {
            width: 40%;
            border-right: 1px solid #eee;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .custom-cascade-select .year-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }
        
        .custom-cascade-select .year-item:hover {
            background: #f5f5f5;
        }
        
        .custom-cascade-select .year-item.active {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }
        
        /* 右侧测算口径列表 */
        .custom-cascade-select .type-list {
            width: 60%;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .custom-cascade-select .type-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }
        
        .custom-cascade-select .type-item:hover {
            background: #f5f5f5;
        }
        
        .custom-cascade-select .type-item.selected {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .custom-cascade-select .empty-hint {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }
        
        /* 建筑面积类型多选框 */
        .custom-multi-select {
            position: relative;
            width: 100%;
        }
        
        .custom-multi-select .select-display {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 38px;
        }
        
        .custom-multi-select .select-display:hover {
            border-color: #1976d2;
        }
        
        .custom-multi-select .select-display::after {
            content: '▼';
            font-size: 12px;
            color: #666;
        }
        
        .custom-multi-select .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .custom-multi-select .dropdown-list.show {
            display: block;
        }
        
        .custom-multi-select .option-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .custom-multi-select .option-item:hover {
            background: #f5f5f5;
        }
        
        .custom-multi-select .option-item input[type="checkbox"] {
            cursor: pointer;
        }
        
        .custom-multi-select .display-text {
            flex: 1;
            overflow: hidden;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .custom-multi-select .selected-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 3px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .custom-multi-select .placeholder-text {
            color: #999;
        }
        
        /* 建筑面积底数显示 */
        .baseline-areas-section {
            margin-bottom: 20px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .baseline-areas-text {
            font-size: 13px;
            color: #333;
            line-height: 1.6;
        }
        
        .baseline-areas-empty {
            font-size: 13px;
            color: #999;
        }
        
        /* 测算结果显示区域 */
        .calculation-results-section {
            margin-top: 20px;
        }
        
        /* 提示文字样式 */
        .calculation-tips {
            padding: 0;
            margin-bottom: 15px;
            color: #999999;
            font-size: 13px;
            line-height: 1.6;
            text-align: center;
        }
        
        .result-card {
            margin-bottom: 20px;
            padding: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .result-card-header {
            font-size: 13px;
            font-weight: 400;
            color: #666;
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-header-item {
            flex: 1;
        }
        
        .result-header-item:not(:last-child) {
            border-right: 1px solid #dee2e6;
            padding-right: 12px;
            margin-right: 12px;
        }
        
        /* 测算结果表格 */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .result-table th {
            background: #f5f5f5;
            color: #333;
            font-weight: 500;
            font-size: 13px;  /* 明确设置字体大小 */
            padding: 10px 12px;
            text-align: center;
            vertical-align: middle;  /* 垂直居中 */
            border-bottom: 2px solid #e0e0e0;
            border-right: 1px solid #e0e0e0;
        }
        
        .result-table th:last-child {
            border-right: none;
        }
        
        .result-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #f0f0f0;
            color: #333;  /* 确保所有单元格文字为深灰色 */
            font-size: 13px;  /* 明确设置字体大小，与表头一致 */
            text-align: center;  /* 水平居中 */
            vertical-align: middle;  /* 垂直居中 */
        }
        
        .result-table td:last-child {
            border-right: none;
        }
        
        .result-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* 第一列所有单元格灰色背景 */
        .result-table td:first-child {
            background: #f5f5f5;
        }
        
        .result-table .row-header {
            background: #f5f5f5;
            font-weight: 500;
            color: #333;
        }
        
        .result-table .indent-row {
            color: #333;
            background: #f5f5f5;
            /* padding-left 在居中时不再适用，改为文字前添加空格或使用其他方式 */
        }
        
        .result-table .subtotal-row {
            font-weight: 500;
            color: #333;  /* 小计行文字颜色 */
        }
        
        .result-table .subtotal-row td:first-child {
            background: #f5f5f5;
        }
        
        .result-table .summary-row {
            font-weight: 500;
            color: #333;  /* 汇总行文字颜色 */
        }
        
        /* 最后三行第二列灰色背景 */
        .result-table .summary-row td:nth-child(2),
        .result-table .special-subsidy-row td:nth-child(2),
        .result-table .total-row td:nth-child(2) {
            background: #f5f5f5;
            font-weight: 500;
        }
        
        .result-table .special-subsidy-row {
            font-weight: 500;
            color: #333;  /* 特殊补助行文字颜色 */
        }
        
        .result-table .total-row {
            font-weight: 600;
            color: #333;  /* 总计行文字颜色 */
            /* font-size 已在 td 中统一设置为 13px */
        }
        
        .result-table .value-column {
            color: #333;  /* 数值列文字颜色 */
            /* 移除了 font-family，使用默认字体以保持一致性 */
            /* text-align 已在 td 中设置为 center，这里不再覆盖 */
        }
        
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 13px;
        }
        
        /* 添加按钮容器 */
        .add-planning-row {
            margin-top: 15px;
        }
        
        .btn-add-planning {
            width: 100%;
            padding: 12px 20px;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-add-planning:hover {
            border-color: #1976d2;
            color: #1976d2;
            background: #f5f9ff;
        }
        
        /* 学年规划区域 */
        .planning-section {
            margin: 20px 0;
        }
        
        .planning-header {
            display: grid;
            grid-template-columns: 1fr 1.5fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .header-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .btn-enter-area {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .planning-row {
            display: grid;
            grid-template-columns: 1fr 1.5fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .year-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .area-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .area-tag {
            display: inline-block;
            padding: 6px 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            color: #333;
        }
        
        .btn-delete {
            background: white;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            color: #1976d2;
            cursor: pointer;
        }
        
        .add-row {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
        }
        
        .btn-add {
            background: white;
            border: 1px dashed #ddd;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            width: 100%;
        }
        
        /* 底部按钮 */
        .action-buttons-left {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn-reset-white {
            flex: 1;
            padding: 12px 20px;
            background: white;
            border: 1px solid #333;
            color: #333;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-reset-white:hover {
            background: #f5f5f5;
        }
        
        .btn-calculate-blue {
            flex: 2;
            padding: 12px 20px;
            background: #1976d2;
            color: white;
            border: 1px solid #1976d2;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-calculate-blue:hover {
            background: #1565c0;
            border-color: #1565c0;
        }
        
        .btn-download {
            flex: 1;
            padding: 12px 20px;
            background: white;
            border: 1px solid #1976d2;
            color: #1976d2;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-download:hover {
            background: #e3f2fd;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏容器 -->
        <div id="sidebarContainer"></div>

        <!-- 主内容区域 -->
        <main class="main-content">
            <div class="page-content active">
                <!-- 页面头部容器 -->
                <div id="pageHeaderContainer"></div>
                
                <!-- 页面内容容器 -->
                <div class="content-body" id="pageContentContainer">
                    <div class="new-calculation-container">
                        <!-- 两列卡片容器 -->
                        <div class="cards-row">
                            <!-- 左侧卡片 -->
                            <div class="data-card">
                                <div class="card-content">
                                    <!-- 单位/学校名称 -->
                                    <div class="form-group">
                                        <label>单位/学校(机构)名称(章)</label>
                                        <select id="schoolNameNew" class="form-control" onchange="handleSchoolChangeNew()">
                                            <option value="">请选择学校</option>
                                        </select>
                                        <small id="schoolTypeDisplayNew" style="display: none;"></small>
                                    </div>

                                    <!-- 缺口计算方式 -->
                                    <!-- 
                                        未来如需修改缺口计算方式：
                                        1. 修改下拉框的选项文本或添加多个选项
                                        2. 如需启用选择功能，移除 disabled 属性
                                        3. 下载功能会自动获取选中的计算方式
                                    -->
                                    <div class="form-group">
                                        <label>缺口计算方式:</label>
                                        <select id="calculationMethod" class="form-control" disabled style="background: #f5f5f5; cursor: not-allowed;">
                                            <option value="gap_positive">测算面积-建筑面积>0, 表示有缺口</option>
                                            <!-- 未来可添加其他计算方式，例如：
                                            <option value="gap_negative">建筑面积-测算面积>0, 表示有富余</option>
                                            <option value="percentage">缺口百分比计算</option>
                                            -->
                                        </select>
                                    </div>

                                    <!-- 规划表格 -->
                                    <div class="planning-table-container">
                                        <table class="planning-table">
                                            <thead>
                                                <tr>
                                                    <th>学生规划参数</th>
                                                    <th>
                                                        计入测算的建筑面积
                                                        <span class="info-icon" title="计入建筑面积(m)汇总">ⓘ</span>
                                                    </th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="planningTableBody">
                                                <!-- 表格内容将在这里动态添加 -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- 添加按钮 -->
                                    <div class="add-planning-row">
                                        <button class="btn-add-planning" onclick="addPlanningRow()">
                                            + 添加
                                        </button>
                                    </div>

                                    <!-- 底部操作按钮 -->
                                    <div class="action-buttons-left">
                                        <button class="btn-reset-white" onclick="resetForm()">重置</button>
                                        <button class="btn-calculate-blue" onclick="startCalculation()">开始测算</button>
                                        <button class="btn-download" onclick="downloadResult()">下载</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 右侧卡片 -->
                            <div class="data-card">
                                <div class="card-content">
                                    <!-- 建筑面积底数显示 -->
                                    <div id="baselineAreasContainer" class="baseline-areas-section" style="display: none;">
                                        <div id="baselineAreasContent" class="baseline-areas-empty">
                                            请先选择学校
                                        </div>
                                    </div>

                                    <!-- 测算提示文字（仅在无测算结果时显示） -->
                                    <div id="calculationTips" class="calculation-tips" style="display: none;">
                                        请先添加测算条件，再点击【开始测算】按钮，每次测算结果都会自动保存至历史测算。
                                    </div>

                                    <!-- 测算结果显示区域 -->
                                    <div id="calculationResultsContainer" class="calculation-results-section">
                                        <div class="no-results">
                                            点击"开始测算"按钮查看结果
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入外部脚本 -->
    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/componentManager.js"></script>
    <script src="../js/dataEntryNew.js"></script>
    
    <script>
        // 全局变量：存储最新的测算结果
        let latestCalculationResults = null;
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('高校测算页面加载完成，开始初始化...');
                
                // 初始化页面结构
                await ComponentManager.initPageStructure({
                    title: '高校测算',
                    description: '根据面积补助标准，测算建筑面积缺口',
                    activeMenu: 'menu-data-entry-new'
                });
                
                // 初始化认证模块
                await AuthManager.initialize();
                const user = AuthManager.getCurrentUser();
                if (user) {
                    AuthManager.updateUserInfo(user);
                    AuthManager.updateMenuVisibility(user);
                }

                // 初始化数据填报模块
                if (typeof DataEntryNewManager !== 'undefined') {
                    await DataEntryNewManager.initialize();
                    console.log('数据填报模块初始化完成');
                }
                
                // 初始化时显示提示文字
                const tipsElement = document.getElementById('calculationTips');
                if (tipsElement) {
                    tipsElement.style.display = 'block';
                }

                // 初始化离开确认逻辑
                initializeNavigationGuard();

            } catch (error) {
                console.error('页面初始化失败:', error);
                if (error.message.includes('unauthorized') || error.message.includes('login')) {
                    window.location.href = '../login.html';
                }
            }
        });

        // 初始化导航守卫：当有测算结果时提示确认离开
        function initializeNavigationGuard() {
            // 等待侧边栏加载完成
            const checkSidebar = setInterval(() => {
                const menuItems = document.querySelectorAll('.menu-item');
                if (menuItems.length > 0) {
                    clearInterval(checkSidebar);
                    
                    // 为每个菜单项添加点击拦截
                    menuItems.forEach(menuItem => {
                        // 跳过当前页面的菜单项
                        if (menuItem.id === 'menu-data-entry-new') {
                            return;
                        }
                        
                        menuItem.addEventListener('click', function(e) {
                            // 检查是否有测算结果
                            if (hasCalculationResults()) {
                                // 阻止默认导航
                                e.preventDefault();
                                
                                // 显示确认对话框
                                if (confirm('离开后将重置数据，是否确认离开？')) {
                                    // 用户确认离开，清除测算结果
                                    latestCalculationResults = null;
                                    
                                    // 执行原始导航（直接使用 href，不管是否是 SPA 模式）
                                    const href = this.getAttribute('href');
                                    if (href) {
                                        window.location.href = href;
                                    }
                                }
                                // 用户取消，不做任何操作
                            }
                            // 如果没有测算结果，允许正常导航（不阻止默认行为）
                        });
                    });
                    
                    console.log('✅ 导航守卫已初始化');
                }
            }, 100);
            
            // 超时保护，5秒后停止检查
            setTimeout(() => {
                clearInterval(checkSidebar);
            }, 5000);
        }

        // 检查是否有测算结果
        function hasCalculationResults() {
            // 方法1：检查全局变量
            if (latestCalculationResults && latestCalculationResults.length > 0) {
                return true;
            }
            
            // 方法2：检查DOM中是否有结果卡片
            const resultsContainer = document.getElementById('calculationResultsContainer');
            if (resultsContainer) {
                const resultCards = resultsContainer.querySelectorAll('.result-card');
                if (resultCards.length > 0) {
                    return true;
                }
            }
            
            return false;
        }

        // 处理学校选择变化
        function handleSchoolChangeNew() {
            console.log('=== 学校选择已变更，开始重置表单 ===');
            
            const schoolSelect = document.getElementById('schoolNameNew');
            const selectedOption = schoolSelect.options[schoolSelect.selectedIndex];
            const schoolTypeDisplay = document.getElementById('schoolTypeDisplayNew');

            if (schoolSelect.value && schoolTypeDisplay) {
                // 保存当前选择的学校
                const savedSchool = schoolSelect.value;
                console.log('选择的学校:', savedSchool);
                
                // 执行重置操作（不包括学校选择器和确认对话框）
                console.log('开始重置表单内容...');
                
                // 清空规划表格
                const tbody = document.getElementById('planningTableBody');
                if (tbody) {
                    tbody.innerHTML = '';
                    console.log('已清空规划表格');
                }
                
                // 清空测算结果
                const resultsContainer = document.getElementById('calculationResultsContainer');
                if (resultsContainer) {
                    resultsContainer.innerHTML = '';
                    console.log('已清空测算结果');
                }
                
                // 清空全局测算结果
                if (typeof latestCalculationResults !== 'undefined') {
                    latestCalculationResults = null;
                    console.log('已清空全局测算结果');
                }
                
                // 隐藏建筑面积底数
                hideBaselineAreas();
                
                // 恢复学校选择
                schoolSelect.value = savedSchool;
                
                // 显示学校类型
                const schoolType = selectedOption.dataset.schoolType || '';
                schoolTypeDisplay.textContent = schoolType ? `学校类型: ${schoolType}` : '';
                schoolTypeDisplay.style.display = schoolType ? 'block' : 'none';
                
                console.log('表单已重置，保留学校:', savedSchool, '学校类型:', schoolType);
                
                // 加载新学校的建筑面积底数
                loadBaselineAreas(schoolSelect.value);
            } else if (schoolTypeDisplay) {
                console.log('未选择学校，隐藏学校类型');
                schoolTypeDisplay.style.display = 'none';
                // 隐藏建筑面积底数
                hideBaselineAreas();
                // 禁用所有行的筛选器
                disablePlanningFilters();
            }
        }
        
        // 启用所有筛选器
        function enablePlanningFilters() {
            const tbody = document.getElementById('planningTableBody');
            if (tbody) {
                const displays = tbody.querySelectorAll('.custom-cascade-select .select-display');
                displays.forEach(display => {
                    display.classList.remove('disabled');
                });
            }
        }
        
        // 禁用所有筛选器
        function disablePlanningFilters() {
            const tbody = document.getElementById('planningTableBody');
            if (tbody) {
                const displays = tbody.querySelectorAll('.custom-cascade-select .select-display');
                displays.forEach(display => {
                    display.classList.add('disabled');
                    display.querySelector('.display-text').textContent = '请先选择学校';
                });
            }
        }

        // 添加规划表格行
        async function addPlanningRow() {
            const tbody = document.getElementById('planningTableBody');
            const schoolSelect = document.getElementById('schoolNameNew');
            
            if (!tbody) {
                console.error('未找到表格tbody元素');
                return;
            }
            
            const schoolName = schoolSelect.value;
            const isSchoolSelected = schoolName !== '';
            const rowId = 'row_' + Date.now();

            // 创建新行
            const newRow = document.createElement('tr');
            newRow.id = rowId;
            newRow.innerHTML = `
                <td>
                    <div class="custom-cascade-select" id="select_${rowId}">
                        <div class="select-display ${!isSchoolSelected ? 'disabled' : ''}" onclick="toggleCascadeDropdown('${rowId}')">
                            <span class="display-text">${!isSchoolSelected ? '请先选择学校' : '请选择'}</span>
                        </div>
                        <div class="dropdown-panel">
                            <div class="year-list">
                                <div class="empty-hint">加载中...</div>
                            </div>
                            <div class="type-list">
                                <div class="empty-hint">请先选择年份</div>
                            </div>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="custom-multi-select" id="areaType_${rowId}">
                        <div class="select-display" onclick="toggleAreaTypeDropdown('${rowId}')">
                            <span class="display-text">请选择</span>
                        </div>
                        <div class="dropdown-list">
                            <div class="option-item" onclick="toggleAreaTypeOption(this, '${rowId}')">
                                <input type="checkbox" value="现状" data-shortname="现状">
                                <span>现状</span>
                            </div>
                            <div class="option-item" onclick="toggleAreaTypeOption(this, '${rowId}')">
                                <input type="checkbox" value="拟建成_前期" data-shortname="前期">
                                <span>拟建成_前期</span>
                            </div>
                            <div class="option-item" onclick="toggleAreaTypeOption(this, '${rowId}')">
                                <input type="checkbox" value="拟建成_在建(含竣工)" data-shortname="在建">
                                <span>拟建成_在建(含竣工)</span>
                            </div>
                            <div class="option-item" onclick="toggleAreaTypeOption(this, '${rowId}')">
                                <input type="checkbox" value="特殊补助" data-shortname="补助">
                                <span>特殊补助</span>
                            </div>
                        </div>
                    </div>
                </td>
                <td style="text-align: center;">
                    <a href="javascript:void(0)" 
                       class="delete-link" 
                       onclick="deletePlanningRow(this)"
                       style="color: #f44336; text-decoration: none; cursor: pointer;">删除</a>
                </td>
            `;

            // 添加到表格
            tbody.appendChild(newRow);
            
            // 如果已选择学校，加载级联数据
            if (isSchoolSelected) {
                await loadCascadeData(rowId, schoolName);
            }
            
            console.log('已添加新规划行');
        }
        
        // 加载级联数据
        async function loadCascadeData(rowId, schoolName) {
            try {
                const response = await fetch(`/api/planned-students?schoolName=${encodeURIComponent(schoolName)}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const selectContainer = document.getElementById(`select_${rowId}`);
                    if (!selectContainer) return;
                    
                    // 存储数据
                    selectContainer.dataset.planningData = JSON.stringify(data.data);
                    
                    // 按年份分组
                    const groupedData = {};
                    data.data.forEach(item => {
                        const year = item.year;
                        if (!groupedData[year]) {
                            groupedData[year] = [];
                        }
                        groupedData[year].push(item);
                    });
                    
                    // 按年份升序排列（从小到大）
                    const years = Object.keys(groupedData).sort((a, b) => a - b);
                    
                    // 填充年份列表
                    const yearList = selectContainer.querySelector('.year-list');
                    yearList.innerHTML = '';
                    
                    years.forEach(year => {
                        const yearItem = document.createElement('div');
                        yearItem.className = 'year-item';
                        yearItem.textContent = year;
                        yearItem.dataset.year = year;
                        yearItem.onclick = () => selectYear(rowId, year, groupedData[year]);
                        yearList.appendChild(yearItem);
                    });
                }
            } catch (error) {
                console.error('加载级联数据失败:', error);
            }
        }
        
        // 切换下拉面板
        function toggleCascadeDropdown(rowId) {
            const selectContainer = document.getElementById(`select_${rowId}`);
            if (!selectContainer) return;
            
            const display = selectContainer.querySelector('.select-display');
            if (display.classList.contains('disabled')) return;
            
            const panel = selectContainer.querySelector('.dropdown-panel');
            
            // 关闭其他所有下拉面板
            document.querySelectorAll('.dropdown-panel.show').forEach(p => {
                if (p !== panel) p.classList.remove('show');
            });
            
            panel.classList.toggle('show');
        }
        
        // 选择年份
        function selectYear(rowId, year, typeData) {
            const selectContainer = document.getElementById(`select_${rowId}`);
            if (!selectContainer) return;
            
            // 高亮选中的年份
            selectContainer.querySelectorAll('.year-item').forEach(item => {
                item.classList.remove('active');
                item.classList.remove('selected');
                if (item.dataset.year === year.toString()) {
                    item.classList.add('active');
                    item.classList.add('selected');
                }
            });
            
            // 填充测算口径列表
            const typeList = selectContainer.querySelector('.type-list');
            typeList.innerHTML = '';
            
            typeData.forEach(item => {
                const typeItem = document.createElement('div');
                typeItem.className = 'type-item';
                typeItem.textContent = item.calculation_criteria || '基本表';
                typeItem.dataset.id = item.id;
                typeItem.dataset.studentCount = item.planned_students;
                typeItem.dataset.area = item.included_area;
                typeItem.dataset.year = year;
                typeItem.dataset.type = item.calculation_criteria || '基本表';
                typeItem.onclick = () => selectType(rowId, typeItem);
                typeList.appendChild(typeItem);
            });
        }
        
        // 选择测算口径
        function selectType(rowId, typeItem) {
            const selectContainer = document.getElementById(`select_${rowId}`);
            if (!selectContainer) return;
            
            const year = typeItem.dataset.year;
            const type = typeItem.dataset.type;
            
            // 高亮选中的测算口径
            selectContainer.querySelectorAll('.type-item').forEach(item => {
                item.classList.remove('selected');
            });
            typeItem.classList.add('selected');
            
            // 更新显示文本
            const displayText = selectContainer.querySelector('.display-text');
            displayText.textContent = `${year}/${type}`;
            
            // 存储选中的值
            selectContainer.dataset.selectedId = typeItem.dataset.id;
            selectContainer.dataset.selectedYear = year;
            selectContainer.dataset.selectedType = type;
            
            // 关闭下拉面板
            selectContainer.querySelector('.dropdown-panel').classList.remove('show');
            
            console.log('已选择:', { year, type });
        }
        
        // 点击外部关闭下拉面板
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-cascade-select')) {
                document.querySelectorAll('.dropdown-panel.show').forEach(panel => {
                    panel.classList.remove('show');
                });
            }
            if (!e.target.closest('.custom-multi-select')) {
                document.querySelectorAll('.custom-multi-select .dropdown-list.show').forEach(list => {
                    list.classList.remove('show');
                });
            }
        });
        
        // 切换建筑面积类型下拉框
        function toggleAreaTypeDropdown(rowId) {
            const container = document.getElementById(`areaType_${rowId}`);
            if (!container) return;
            
            const dropdown = container.querySelector('.dropdown-list');
            
            // 关闭其他所有下拉框
            document.querySelectorAll('.custom-multi-select .dropdown-list.show').forEach(list => {
                if (list !== dropdown) list.classList.remove('show');
            });
            
            dropdown.classList.toggle('show');
        }
        
        // 切换建筑面积类型选项
        function toggleAreaTypeOption(optionItem, rowId) {
            const checkbox = optionItem.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            // 更新显示文本
            updateAreaTypeDisplay(rowId);
            
            // 阻止事件冒泡
            event.stopPropagation();
        }
        
        // 更新建筑面积类型显示文本
        function updateAreaTypeDisplay(rowId) {
            const container = document.getElementById(`areaType_${rowId}`);
            if (!container) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            const displayText = container.querySelector('.display-text');
            
            // 清空显示区域
            displayText.innerHTML = '';
            
            if (checkboxes.length === 0) {
                // 无选中项时显示占位符
                const placeholder = document.createElement('span');
                placeholder.className = 'placeholder-text';
                placeholder.textContent = '请选择';
                displayText.appendChild(placeholder);
            } else {
                // 为每个选中项创建标签
                checkboxes.forEach(checkbox => {
                    const tag = document.createElement('span');
                    tag.className = 'selected-tag';
                    tag.textContent = checkbox.dataset.shortname || checkbox.value;
                    displayText.appendChild(tag);
                });
            }
        }

        // 删除规划表格行
        function deletePlanningRow(btn) {
            const row = btn.closest('tr');
            if (row) {
                row.remove();
                console.log('已删除规划行');
            }
        }

        // 加载建筑面积底数
        async function loadBaselineAreas(schoolName) {
            if (!schoolName) {
                hideBaselineAreas();
                return;
            }
            
            try {
                console.log('正在加载学校建筑面积底数:', schoolName);
                
                // 获取基础建筑面积数据
                const baselineResponse = await fetch(`/api/baseline-areas?school_name=${encodeURIComponent(schoolName)}`);
                
                if (!baselineResponse.ok) {
                    throw new Error('获取基础建筑面积数据失败');
                }
                
                const baselineData = await baselineResponse.json();
                
                // 获取特殊补助数据
                const subsidyResponse = await fetch(`/api/special-subsidy-baselines?school_name=${encodeURIComponent(schoolName)}`);
                
                if (!subsidyResponse.ok) {
                    throw new Error('获取特殊补助数据失败');
                }
                
                const subsidyData = await subsidyResponse.json();
                
                // 计算四类建筑面积
                const areas = calculateBaselineAreas(baselineData, subsidyData);
                
                // 显示建筑面积底数
                displayBaselineAreas(areas);
                
            } catch (error) {
                console.error('加载建筑面积底数失败:', error);
                showBaselineAreasError();
            }
        }

        // 计算四类建筑面积底数
        function calculateBaselineAreas(baselineData, subsidyData) {
            const areas = {
                current: 0,           // 现状总面积
                planned: 0,           // 拟建成_前期总面积
                underConstruction: 0, // 拟建成_在建(含竣工)总面积
                specialSubsidy: 0     // 特殊用房总面积
            };
            
            // 从基础建筑面积数据中提取
            if (baselineData && baselineData.data && baselineData.data.length > 0) {
                const baseline = baselineData.data[0]; // 每个学校+用户只有一条记录
                areas.current = parseFloat(baseline.current_total_area || 0);
                areas.planned = parseFloat(baseline.planned_total_area || 0);
                areas.underConstruction = parseFloat(baseline.under_construction_total_area || 0);
            }
            
            // 从特殊补助数据中汇总
            if (subsidyData && subsidyData.data && subsidyData.data.length > 0) {
                areas.specialSubsidy = subsidyData.data.reduce((sum, item) => {
                    return sum + parseFloat(item.subsidy_area || 0);
                }, 0);
            }
            
            return areas;
        }

        // 显示建筑面积底数
        function displayBaselineAreas(areas) {
            const container = document.getElementById('baselineAreasContainer');
            const content = document.getElementById('baselineAreasContent');
            
            if (!container || !content) return;
            
            // 显示容器
            container.style.display = 'block';
            
            // 构建一行文字
            const text = `建筑面积底数：现状面积: ${areas.current.toFixed(2)}㎡  拟建成_前期: ${areas.planned.toFixed(2)}㎡  拟建成_在建(含竣工): ${areas.underConstruction.toFixed(2)}㎡  特殊用房: ${areas.specialSubsidy.toFixed(2)}㎡`;
            
            content.className = 'baseline-areas-text';
            content.textContent = text;
            
            console.log('建筑面积底数已显示:', areas);
        }

        // 隐藏建筑面积底数
        function hideBaselineAreas() {
            const container = document.getElementById('baselineAreasContainer');
            const content = document.getElementById('baselineAreasContent');
            
            if (container) {
                container.style.display = 'none';
            }
            
            if (content) {
                content.className = 'baseline-areas-empty';
                content.textContent = '请先选择学校';
            }
        }

        // 显示建筑面积底数错误
        function showBaselineAreasError() {
            const container = document.getElementById('baselineAreasContainer');
            const content = document.getElementById('baselineAreasContent');
            
            if (container) {
                container.style.display = 'block';
            }
            
            if (content) {
                content.className = 'baseline-areas-empty';
                content.textContent = '暂无建筑面积底数数据';
            }
        }

        // 重置表单
        function resetForm() {
            if (!confirm('确定要重置所有数据吗？此操作不可恢复。')) {
                return;
            }
            
            // 获取当前用户信息
            const currentUser = typeof AuthManager !== 'undefined' ? AuthManager.getCurrentUser() : null;
            const isSchoolUser = currentUser && currentUser.role === 'school';
            
            // 重置学校选择（学校用户不清空学校名称）
            const schoolSelect = document.getElementById('schoolNameNew');
            if (schoolSelect) {
                // 如果是学校用户，保留当前学校名称；否则清空
                if (isSchoolUser && currentUser.school_name) {
                    // 学校用户保持学校名称不变
                    schoolSelect.value = currentUser.school_name;
                    console.log('学校用户重置表单：保留学校名称', currentUser.school_name);
                    // 触发学校变更事件以保持学校类型等信息
                    handleSchoolChangeNew();
                } else {
                    // 管理员和建设中心用户清空学校选择
                    schoolSelect.value = '';
                    console.log('非学校用户重置表单：清空学校名称');
                    handleSchoolChangeNew();
                }
            }
            
            // 清空规划表格
            const tbody = document.getElementById('planningTableBody');
            if (tbody) {
                tbody.innerHTML = '';
            }
            
            // 清空测算结果
            const resultsContainer = document.getElementById('calculationResultsContainer');
            if (resultsContainer) {
                resultsContainer.innerHTML = '<div class="no-results">点击"开始测算"按钮查看结果</div>';
            }
            
            // 显示提示文字
            const tipsElement = document.getElementById('calculationTips');
            if (tipsElement) {
                tipsElement.style.display = 'block';
            }
            
            // 清空全局测算结果
            latestCalculationResults = null;
            
            console.log('表单已重置');
        }

        // 开始测算
        async function startCalculation() {
            const schoolSelect = document.getElementById('schoolNameNew');
            
            if (!schoolSelect || !schoolSelect.value) {
                alert('请先选择学校');
                return;
            }
            
            const tbody = document.getElementById('planningTableBody');
            const rows = tbody?.querySelectorAll('tr[id^="row_"]');
            
            if (!rows || rows.length === 0) {
                alert('请至少添加一条测算条件，即学生规划参数和计入测算的建筑面积');
                return;
            }
            
            // 收集所有测算组合
            const calculations = [];
            let isValid = true;
            let validationErrors = [];
            
            rows.forEach(row => {
                const rowId = row.id;
                const yearList = document.querySelector(`#${rowId} .year-list`);
                const typeList = document.querySelector(`#${rowId} .type-list`);
                const areaTypeContainer = document.getElementById(`areaType_${rowId}`);
                
                const selectedYear = yearList?.querySelector('.year-item.selected');
                const selectedType = typeList?.querySelector('.type-item.selected');
                const selectedAreaTypes = areaTypeContainer?.querySelectorAll('input[type="checkbox"]:checked');
                
                // 调试信息
                console.log(`验证行 ${rowId}:`, {
                    yearList: !!yearList,
                    selectedYear: !!selectedYear,
                    selectedYearText: selectedYear?.textContent,
                    typeList: !!typeList,
                    selectedType: !!selectedType,
                    selectedTypeText: selectedType?.textContent,
                    areaTypeContainer: !!areaTypeContainer,
                    selectedAreaTypesCount: selectedAreaTypes?.length || 0
                });
                
                if (!selectedYear) {
                    validationErrors.push(`${rowId}: 未选择年份`);
                    isValid = false;
                }
                if (!selectedType) {
                    validationErrors.push(`${rowId}: 未选择测算口径`);
                    isValid = false;
                }
                if (!selectedAreaTypes || selectedAreaTypes.length === 0) {
                    validationErrors.push(`${rowId}: 未选择建筑面积类型`);
                    isValid = false;
                }
                
                if (!selectedYear || !selectedType || !selectedAreaTypes || selectedAreaTypes.length === 0) {
                    return;
                }
                
                // 收集选中的建筑面积类型
                const areaTypes = Array.from(selectedAreaTypes).map(cb => cb.value);
                
                calculations.push({
                    year: selectedYear.textContent,
                    calculationCriteria: selectedType.textContent,
                    areaTypes: areaTypes,
                    rowId: rowId
                });
            });
            
            if (!isValid) {
                console.error('验证失败:', validationErrors);
                alert('请完整填写所有规划学生数记录（年份、测算口径和建筑面积类型）');
                return;
            }
            
            console.log('开始测算...', calculations);
            
            try {
                // 执行所有测算
                const results = await performAllCalculations(schoolSelect.value, calculations);
                
                console.log('测算完成，返回结果:', results);
                
                // 保存测算结果到全局变量
                latestCalculationResults = results;
                
                // 显示结果
                displayCalculationResults(results);
                
            } catch (error) {
                console.error('测算失败:', error);
                alert('测算失败: ' + error.message);
            }
        }

        // 执行所有测算
        async function performAllCalculations(schoolName, calculations) {
            console.log('performAllCalculations 开始，学校:', schoolName, '测算组合数:', calculations.length);
            
            const results = [];
            
            // 获取建筑面积底数（用于计算现状面积）
            const baselineResponse = await fetch(`/api/baseline-areas?school_name=${encodeURIComponent(schoolName)}`);
            if (!baselineResponse.ok) {
                throw new Error('获取建筑面积底数失败');
            }
            const baselineData = await baselineResponse.json();
            console.log('获取到建筑面积底数:', baselineData);
            
            const subsidyResponse = await fetch(`/api/special-subsidy-baselines?school_name=${encodeURIComponent(schoolName)}`);
            if (!subsidyResponse.ok) {
                throw new Error('获取特殊补助数据失败');
            }
            const subsidyData = await subsidyResponse.json();
            console.log('获取到特殊补助数据:', subsidyData);
            
            // 建筑面积底数
            let baseline = null;
            if (baselineData && baselineData.data && baselineData.data.length > 0) {
                baseline = baselineData.data[0];
            }
            
            // 特殊补助数据
            const specialSubsidies = subsidyData?.data || [];
            
            // 对每个组合进行测算
            for (const calc of calculations) {
                try {
                    // 获取该年份和测算口径的规划学生数
                    const plannedResponse = await fetch(
                        `/api/planned-students?school_name=${encodeURIComponent(schoolName)}&year=${calc.year}&calculation_criteria=${encodeURIComponent(calc.calculationCriteria)}`
                    );
                    
                    if (!plannedResponse.ok) {
                        throw new Error(`获取规划学生数失败: ${calc.year} - ${calc.calculationCriteria}`);
                    }
                    
                    const plannedData = await plannedResponse.json();
                    
                    if (!plannedData.data || plannedData.data.length === 0) {
                        throw new Error(`未找到规划学生数数据: ${calc.year} - ${calc.calculationCriteria}`);
                    }
                    
                    const studentData = plannedData.data[0];
                    
                    // 计算该组合的现状面积（根据选中的建筑面积类型）
                    const currentTotalArea = calculateCurrentArea(baseline, specialSubsidies, calc.areaTypes);
                    
                    // 构造测算数据
                    const calculationData = {
                        '学校名称': schoolName,
                        '年份': calc.year,
                        '人口测算范围': calc.calculationCriteria,  // 添加测算口径
                        '全日制本科生人数': studentData.full_time_undergraduate || 0,
                        '全日制专科生人数': studentData.full_time_specialist || 0,
                        '全日制硕士生人数': studentData.full_time_master || 0,
                        '全日制博士生人数': studentData.full_time_doctor || 0,
                        '留学生本科生人数': studentData.international_undergraduate || 0,
                        '留学生硕士生人数': studentData.international_master || 0,
                        '留学生博士生人数': studentData.international_doctor || 0,
                        '现有教学及辅助用房面积': currentTotalArea.teaching || 0,
                        '现有办公用房面积': currentTotalArea.office || 0,
                        '现有学生宿舍面积': currentTotalArea.dormitory || 0,
                        '现有其他生活面积': (currentTotalArea.living || 0) - (currentTotalArea.dormitory || 0),
                        '现有生活用房总面积': currentTotalArea.living || 0,
                        '现有后勤辅助用房面积': currentTotalArea.logistics || 0,
                        // 添加建筑面积类型选择标志
                        '是否包含现有面积': calc.areaTypes.includes('现状'),
                        '是否包含初步计划面积': calc.areaTypes.includes('拟建成_前期'),
                        '是否包含在建面积': calc.areaTypes.includes('拟建成_在建(含竣工)'),
                        '是否包含特殊补助': calc.areaTypes.includes('特殊补助'),
                        // 添加原始数据，供后端分离现状和拟建成
                        'baseline': baseline ? {
                            current_teaching_area: baseline.current_teaching_area || 0,
                            current_office_area: baseline.current_office_area || 0,
                            current_dormitory_area: baseline.current_dormitory_area || 0,
                            current_living_total_area: baseline.current_living_total_area || 0,
                            current_logistics_area: baseline.current_logistics_area || 0,
                            planned_teaching_area: baseline.planned_teaching_area || 0,
                            planned_office_area: baseline.planned_office_area || 0,
                            planned_dormitory_area: baseline.planned_dormitory_area || 0,
                            planned_living_total_area: baseline.planned_living_total_area || 0,
                            planned_logistics_area: baseline.planned_logistics_area || 0,
                            under_construction_teaching_area: baseline.under_construction_teaching_area || 0,
                            under_construction_office_area: baseline.under_construction_office_area || 0,
                            under_construction_dormitory_area: baseline.under_construction_dormitory_area || 0,
                            under_construction_living_total_area: baseline.under_construction_living_total_area || 0,
                            under_construction_logistics_area: baseline.under_construction_logistics_area || 0
                        } : null
                    };
                    
                    // 调试日志
                    console.log(`测算组合 [${calc.year} - ${calc.calculationCriteria}]:`, {
                        学生数据: {
                            本科生: studentData.full_time_undergraduate,
                            专科生: studentData.full_time_specialist,
                            硕士生: studentData.full_time_master,
                            博士生: studentData.full_time_doctor
                        },
                        现状面积: currentTotalArea,
                        建筑面积类型: calc.areaTypes,
                        选择标志: {
                            现状: calc.areaTypes.includes('现状'),
                            前期: calc.areaTypes.includes('拟建成_前期'),
                            在建: calc.areaTypes.includes('拟建成_在建(含竣工)')
                        }
                    });
                    
                    // 准备特殊补助数据（如果用户选中了特殊补助）
                    const specialSubsidiesToSend = calc.areaTypes.includes('特殊补助') 
                        ? specialSubsidies.map(item => ({
                            '特殊用房补助名称': item.subsidy_name || '',
                            '补助面积（m²）': parseFloat(item.subsidy_area || 0)
                          }))
                        : [];
                    
                    // 调用测算API
                    const calcResponse = await fetch('/online-calculate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            schoolData: calculationData,
                            specialSubsidies: specialSubsidiesToSend
                        })
                    });
                    
                    if (!calcResponse.ok) {
                        throw new Error('测算请求失败');
                    }
                    
                    const calcResult = await calcResponse.json();
                    console.log(`API返回结果 [${calc.year} - ${calc.calculationCriteria}]:`, calcResult);
                    
                    // 提取各个阶段的面积数据（根据选中的areaTypes决定是否包含）
                    const includesCurrent = calc.areaTypes.includes('现状');
                    const includesPreliminary = calc.areaTypes.includes('拟建成_前期');
                    const includesUnderConstruction = calc.areaTypes.includes('拟建成_在建(含竣工)');
                    
                    const currentAreas = includesCurrent ? {
                        teaching: parseFloat(baseline?.current_teaching_area || 0),
                        office: parseFloat(baseline?.current_office_area || 0),
                        dormitory: parseFloat(baseline?.current_dormitory_area || 0),
                        living: parseFloat(baseline?.current_living_total_area || 0),
                        otherLiving: parseFloat((baseline?.current_living_total_area || 0) - (baseline?.current_dormitory_area || 0)),
                        logistics: parseFloat(baseline?.current_logistics_area || 0)
                    } : {
                        teaching: 0, office: 0, dormitory: 0, living: 0, otherLiving: 0, logistics: 0
                    };
                    
                    const preliminaryAreas = includesPreliminary ? {
                        teaching: parseFloat(baseline?.planned_teaching_area || 0),
                        office: parseFloat(baseline?.planned_office_area || 0),
                        dormitory: parseFloat(baseline?.planned_dormitory_area || 0),
                        living: parseFloat(baseline?.planned_living_total_area || 0),
                        otherLiving: parseFloat((baseline?.planned_living_total_area || 0) - (baseline?.planned_dormitory_area || 0)),
                        logistics: parseFloat(baseline?.planned_logistics_area || 0)
                    } : {
                        teaching: 0, office: 0, dormitory: 0, living: 0, otherLiving: 0, logistics: 0
                    };
                    
                    const underConstructionAreas = includesUnderConstruction ? {
                        teaching: parseFloat(baseline?.under_construction_teaching_area || 0),
                        office: parseFloat(baseline?.under_construction_office_area || 0),
                        dormitory: parseFloat(baseline?.under_construction_dormitory_area || 0),
                        living: parseFloat(baseline?.under_construction_living_total_area || 0),
                        otherLiving: parseFloat((baseline?.under_construction_living_total_area || 0) - (baseline?.under_construction_dormitory_area || 0)),
                        logistics: parseFloat(baseline?.under_construction_logistics_area || 0)
                    } : {
                        teaching: 0, office: 0, dormitory: 0, living: 0, otherLiving: 0, logistics: 0
                    };
                    
                    results.push({
                        year: calc.year,
                        criteria: calc.calculationCriteria,
                        areaTypes: calc.areaTypes,
                        result: calcResult.analysisResult,
                        studentData: studentData,
                        calculationData: {
                            ...calculationData,
                            currentAreas: currentAreas,
                            preliminaryAreas: preliminaryAreas,
                            underConstructionAreas: underConstructionAreas
                        }
                    });
                    
                    console.log(`已添加到结果数组，当前结果数:`, results.length);
                    
                } catch (error) {
                    console.error(`测算失败 (${calc.year} - ${calc.calculationCriteria}):`, error);
                    throw error;
                }
            }
            
            console.log('performAllCalculations 完成，总结果数:', results.length);
            return results;
        }

        // 根据选中的建筑面积类型计算现状总面积
        function calculateCurrentArea(baseline, specialSubsidies, areaTypes) {
            const result = {
                teaching: 0,
                office: 0,
                dormitory: 0,
                living: 0,
                logistics: 0
            };
            
            if (!baseline) {
                return result;
            }
            
            // 根据选中的类型累加面积
            areaTypes.forEach(type => {
                switch(type) {
                    case '现状':
                        result.teaching += parseFloat(baseline.current_teaching_area || 0);
                        result.office += parseFloat(baseline.current_office_area || 0);
                        result.dormitory += parseFloat(baseline.current_dormitory_area || 0);
                        result.living += parseFloat(baseline.current_living_total_area || 0);
                        result.logistics += parseFloat(baseline.current_logistics_area || 0);
                        break;
                    case '拟建成_前期':
                        result.teaching += parseFloat(baseline.planned_teaching_area || 0);
                        result.office += parseFloat(baseline.planned_office_area || 0);
                        result.dormitory += parseFloat(baseline.planned_dormitory_area || 0);
                        result.living += parseFloat(baseline.planned_living_total_area || 0);
                        result.logistics += parseFloat(baseline.planned_logistics_area || 0);
                        break;
                    case '拟建成_在建(含竣工)':
                        result.teaching += parseFloat(baseline.under_construction_teaching_area || 0);
                        result.office += parseFloat(baseline.under_construction_office_area || 0);
                        result.dormitory += parseFloat(baseline.under_construction_dormitory_area || 0);
                        result.living += parseFloat(baseline.under_construction_living_total_area || 0);
                        result.logistics += parseFloat(baseline.under_construction_logistics_area || 0);
                        break;
                    case '特殊补助':
                        // 特殊补助不计入现状面积，单独处理
                        break;
                }
            });
            
            return result;
        }

        // 显示测算结果
        function displayCalculationResults(results) {
            const container = document.getElementById('calculationResultsContainer');
            const tipsElement = document.getElementById('calculationTips');
            
            if (!container) {
                console.error('找不到测算结果容器');
                return;
            }
            
            console.log('开始显示测算结果，结果数量:', results.length);
            console.log('测算结果详情:', results);
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">暂无测算结果</div>';
                // 显示提示文字
                if (tipsElement) {
                    tipsElement.style.display = 'block';
                }
                return;
            }
            
            // 隐藏提示文字
            if (tipsElement) {
                tipsElement.style.display = 'none';
            }
            
            let html = '';
            
            results.forEach((item, index) => {
                console.log(`处理第 ${index + 1} 个测算结果:`, item);
                
                const result = item.result;
                const studentData = item.studentData;
                const calculationData = item.calculationData;  // 获取保存的计算数据
                
                if (!result) {
                    console.error(`第 ${index + 1} 个结果缺少 result 数据`);
                    return;
                }
                
                if (!studentData) {
                    console.error(`第 ${index + 1} 个结果缺少 studentData 数据`);
                    return;
                }
                
                if (!calculationData) {
                    console.error(`第 ${index + 1} 个结果缺少 calculationData 数据`);
                    return;
                }
                
                // 计算学生总人数
                const totalStudents = (studentData.full_time_undergraduate || 0) + 
                                     (studentData.full_time_specialist || 0) + 
                                     (studentData.full_time_master || 0) + 
                                     (studentData.full_time_doctor || 0) + 
                                     (studentData.international_undergraduate || 0) + 
                                     (studentData.international_master || 0) + 
                                     (studentData.international_doctor || 0);
                
                // 获取数据 - 从传递给后端的calculationData中获取现状面积
                const currentTeaching = calculationData['现有教学及辅助用房面积'] || 0;
                const currentOffice = calculationData['现有办公用房面积'] || 0;
                const currentDormitory = calculationData['现有学生宿舍面积'] || 0;
                const currentLivingTotal = calculationData['现有生活用房总面积'] || 0;
                const currentLogistics = calculationData['现有后勤辅助用房面积'] || 0;
                const currentOtherLiving = currentLivingTotal - currentDormitory; // 计算其他生活用房
                
                const requiredTeaching = result['总应配教学及辅助用房(A)'] || 0;
                const requiredOffice = result['总应配办公用房(B)'] || 0;
                const requiredDormitory = result['总应配学生宿舍(C1)'] || 0;
                const requiredOtherLiving = result['总应配其他生活用房(C2)'] || 0;
                const requiredLogistics = result['总应配后勤辅助用房(D)'] || 0;
                const requiredLivingTotal = requiredDormitory + requiredOtherLiving;
                
                const gapTeaching = result['教学及辅助用房缺口(A)'] || 0;
                const gapOffice = result['办公用房缺口(B)'] || 0;
                const gapDormitory = result['学生宿舍缺口(C1)'] || 0;
                const gapOtherLiving = result['其他生活用房缺口(C2)'] || 0;
                const gapLogistics = result['后勤辅助用房缺口(D)'] || 0;
                const gapLivingTotal = gapDormitory + gapOtherLiving;
                
                const subtotalCurrent = currentTeaching + currentOffice + currentLivingTotal + currentLogistics;
                const subtotalRequired = requiredTeaching + requiredOffice + requiredLivingTotal + requiredLogistics;
                const subtotalGap = gapTeaching + gapOffice + gapLivingTotal + gapLogistics;
                
                const totalGapWithoutSpecial = result['建筑面积总缺口（不含特殊补助）'] || 0;
                const specialSubsidyArea = result['特殊补助总面积'] || 0;
                const totalGapWithSpecial = result['建筑面积总缺口（含特殊补助）'] || 0;
                
                html += `
                    <div class="result-card">
                        <div class="result-card-header">
                            <div class="result-header-item">规划年度：${item.year}</div>
                            <div class="result-header-item">学生总人数(人)：${totalStudents}</div>
                            <div class="result-header-item">测算口径：${item.criteria}</div>
                        </div>
                        <table class="result-table">
                            <thead>
                                <tr>
                                    <th style="width: 25%;"></th>
                                    <th style="width: 25%;">建筑面积(㎡)_汇总</th>
                                    <th style="width: 25%;">建筑面积(㎡)_测算</th>
                                    <th style="width: 25%;">建筑面积(㎡)_缺额</th>
                                </tr>
                                <tr>
                                    <th>用房类型</th>
                                    <th>A</th>
                                    <th>B</th>
                                    <th>B-A</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="row-header">教学及辅助用房</td>
                                    <td class="value-column">${currentTeaching.toFixed(2)}</td>
                                    <td class="value-column">${requiredTeaching.toFixed(2)}</td>
                                    <td class="value-column">${gapTeaching.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td class="row-header">办公用房</td>
                                    <td class="value-column">${currentOffice.toFixed(2)}</td>
                                    <td class="value-column">${requiredOffice.toFixed(2)}</td>
                                    <td class="value-column">${gapOffice.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td class="row-header">生活配套用房</td>
                                    <td class="value-column">${currentLivingTotal.toFixed(2)}</td>
                                    <td class="value-column">${requiredLivingTotal.toFixed(2)}</td>
                                    <td class="value-column">${gapLivingTotal.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td class="indent-row">&nbsp;&nbsp;其中:学生宿舍</td>
                                    <td class="value-column">${currentDormitory.toFixed(2)}</td>
                                    <td class="value-column">${requiredDormitory.toFixed(2)}</td>
                                    <td class="value-column">${gapDormitory.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td class="indent-row">&nbsp;&nbsp;其中:其他生活用房</td>
                                    <td class="value-column">${currentOtherLiving.toFixed(2)}</td>
                                    <td class="value-column">${requiredOtherLiving.toFixed(2)}</td>
                                    <td class="value-column">${gapOtherLiving.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td class="row-header">后勤辅助用房</td>
                                    <td class="value-column">${currentLogistics.toFixed(2)}</td>
                                    <td class="value-column">${requiredLogistics.toFixed(2)}</td>
                                    <td class="value-column">${gapLogistics.toFixed(2)}</td>
                                </tr>
                                <tr class="subtotal-row">
                                    <td>小计</td>
                                    <td class="value-column">${subtotalCurrent.toFixed(2)}</td>
                                    <td class="value-column">${subtotalRequired.toFixed(2)}</td>
                                    <td class="value-column">${subtotalGap.toFixed(2)}</td>
                                </tr>
                                <tr class="summary-row">
                                    <td colspan="2">建筑总面积(㎡)_缺额_不含特殊补助</td>
                                    <td class="value-column">C</td>
                                    <td class="value-column">${totalGapWithoutSpecial.toFixed(2)}</td>
                                </tr>
                                <tr class="special-subsidy-row">
                                    <td colspan="2">特殊补助建筑总面积(㎡)</td>
                                    <td class="value-column">D</td>
                                    <td class="value-column">${specialSubsidyArea.toFixed(2)}</td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="2">建筑总面积(㎡)_缺额_含特殊补助</td>
                                    <td class="value-column">C+D</td>
                                    <td class="value-column">${totalGapWithSpecial.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 下载结果
        function downloadResult() {
            const schoolSelect = document.getElementById('schoolNameNew');
            
            if (!schoolSelect || !schoolSelect.value) {
                alert('请先选择学校并完成测算');
                return;
            }
            
            if (!latestCalculationResults || latestCalculationResults.length === 0) {
                alert('没有可下载的测算结果，请先完成测算');
                return;
            }
            
            console.log('准备下载测算结果...', latestCalculationResults);
            
            // 获取学校信息
            const schoolName = schoolSelect.options[schoolSelect.selectedIndex].text;
            const schoolTypeDisplay = document.getElementById('schoolTypeDisplayNew');
            const schoolType = schoolTypeDisplay ? schoolTypeDisplay.textContent.replace('学校类型: ', '') : '';
            
            // 动态获取缺口计算方式（支持未来可能的变化）
            const calculationMethodSelect = document.getElementById('calculationMethod');
            let calculationMethod = '测算面积-建筑面积>0, 表示有缺口'; // 默认值
            
            if (calculationMethodSelect) {
                // 如果select有值，使用选中项的文本
                const selectedOption = calculationMethodSelect.options[calculationMethodSelect.selectedIndex];
                if (selectedOption && selectedOption.text) {
                    calculationMethod = selectedOption.text;
                } else if (selectedOption && selectedOption.value) {
                    calculationMethod = selectedOption.value;
                }
            }
            
            // 获取当前用户的显示名（优先使用 real_name，回退到 username）
            const currentUser = AuthManager.getCurrentUser();
            let displayName = '未知用户';
            if (currentUser) {
                if (currentUser.real_name && currentUser.real_name.trim()) {
                    displayName = currentUser.real_name;
                } else if (currentUser.username) {
                    displayName = currentUser.username;
                }
            }

            // 调用后端下载接口，传递 displayName 以便 Excel 中显示真实姓名
            downloadCalculationResultsAsExcel(schoolName, schoolType, displayName, calculationMethod, latestCalculationResults);
        }
        
        // 调用后端生成Excel文件并下载
        async function downloadCalculationResultsAsExcel(schoolName, schoolType, userName, calculationMethod, results) {
            try {
                const response = await fetch('/api/download-calculation-results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        schoolName: schoolName,
                        schoolType: schoolType,
                        userName: userName,
                        calculationMethod: calculationMethod,
                        results: results
                    })
                });
                
                if (!response.ok) {
                    throw new Error('下载失败: ' + response.statusText);
                }
                
                // 获取文件名
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = '高校测算结果.xlsx';
                if (contentDisposition) {
                    const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                        // 解码中文文件名
                        filename = decodeURIComponent(filename);
                    }
                }
                
                // 下载文件
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('下载完成');
                
            } catch (error) {
                console.error('下载失败:', error);
                alert('下载失败: ' + error.message);
            }
        }

        // 退出登录
        function logout() {
            if (typeof AuthManager !== 'undefined') {
                AuthManager.logout();
            }
        }
    </script>
</body>
</html>
